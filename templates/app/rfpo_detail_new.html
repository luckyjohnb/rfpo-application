{% extends "app/base.html" %}

{% block title %}RFPO Details - RFPO Application{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1 class="h2 mb-0">
            <i class="fas fa-file-invoice"></i> RFPO Details
        </h1>
        <p class="text-muted" id="rfpoSubtitle">Loading...</p>
    </div>
    <div class="col-md-6 text-end">
        <a href="/rfpos" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<div class="loading text-center py-5">
    <i class="fas fa-spinner fa-spin fa-3x text-muted"></i>
    <p class="text-muted mt-3">Loading RFPO details...</p>
</div>

<div id="rfpoContent" style="display: none;">
    <!-- Row 1: Action Required (full width) -->
    <div id="approvalActionSection" style="display: none;" class="mb-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-gavel"></i> Action Required
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 id="actionStepName">Loading...</h6>
                        <p class="text-muted mb-0" id="actionStageName">Loading...</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success me-2" onclick="showApprovalModal('approved')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-danger" onclick="showApprovalModal('refused')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row 2: Approval Chain + Recent Activity -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <!-- Approval Chain Card -->
            <div id="approvalChainSection" class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-route"></i> Approval Chain
                    </h5>
                </div>
                <div class="card-body">
                    <div id="approvalChainContent">
                        Loading approval chain...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Recent Activity Card -->
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history"></i> Recent Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div id="recentActivityContent">
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>Activity timeline coming soon</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row 3: RFPO Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> RFPO Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">RFPO ID:</dt>
                                <dd class="col-sm-8" id="rfpoId">-</dd>
                                
                                <dt class="col-sm-4">Title:</dt>
                                <dd class="col-sm-8" id="rfpoTitle">-</dd>
                                
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8" id="rfpoStatus">-</dd>
                                
                                <dt class="col-sm-4">Team:</dt>
                                <dd class="col-sm-8" id="rfpoTeam">-</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Vendor:</dt>
                                <dd class="col-sm-8" id="rfpoVendor">-</dd>
                                
                                <dt class="col-sm-4">Due Date:</dt>
                                <dd class="col-sm-8" id="rfpoDueDate">-</dd>
                                
                                <dt class="col-sm-4">Created:</dt>
                                <dd class="col-sm-8" id="rfpoCreated">-</dd>
                                
                                <dt class="col-sm-4">Created By:</dt>
                                <dd class="col-sm-8" id="rfpoCreatedBy">-</dd>
                            </dl>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <dt class="mb-2">Description:</dt>
                            <dd id="rfpoDescription" class="mb-3">-</dd>
                        </div>
                        <div class="col-md-6">
                            <dt class="mb-2">Attached Files:</dt>
                            <dd id="attachedFiles">Loading files...</dd>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row 4: RFPO Document -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt"></i> RFPO Document
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="openRfpoInNewTab()">
                        <i class="fas fa-external-link-alt"></i> Open in New Tab
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="rfpoDocumentContainer" style="height: 600px; overflow-y: auto; border: 1px solid #dee2e6;">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="text-muted mt-2">Loading RFPO document...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const rfpoId = {{ rfpo_id }};
    let currentRfpo = null;

    async function loadRfpoDetails() {
        try {
            showLoading(true);
            const response = await makeApiCall(`/api/rfpos/${rfpoId}`);
            
            if (response.success) {
                currentRfpo = response.rfpo;
                displayRfpoDetails(response);  // Pass full response with approval data
                document.getElementById('rfpoContent').style.display = 'block';
            } else {
                throw new Error(response.message || 'Failed to load RFPO');
            }
        } catch (error) {
            showAlert(`Error loading RFPO: ${error.message}`, 'danger');
        } finally {
            showLoading(false);
        }
    }

    function displayRfpoDetails(data) {
        const rfpo = data.rfpo;
        
        document.getElementById('rfpoSubtitle').textContent = rfpo.rfpo_id + ' - ' + rfpo.title;
        document.getElementById('rfpoId').textContent = rfpo.rfpo_id;
        document.getElementById('rfpoTitle').textContent = rfpo.title;
        document.getElementById('rfpoStatus').innerHTML = getStatusBadge(rfpo.status);
        document.getElementById('rfpoTeam').textContent = rfpo.team_name || 'Unknown';
        document.getElementById('rfpoVendor').textContent = rfpo.vendor_name || 'Not specified';
        document.getElementById('rfpoDueDate').textContent = rfpo.due_date ? new Date(rfpo.due_date).toLocaleDateString() : 'Not set';
        document.getElementById('rfpoCreated').textContent = rfpo.created_at ? new Date(rfpo.created_at).toLocaleDateString() : 'Unknown';
        document.getElementById('rfpoCreatedBy').textContent = rfpo.created_by || 'Unknown';
        document.getElementById('rfpoDescription').textContent = rfpo.description || 'No description provided';
        
        // Update page title
        document.title = `${rfpo.rfpo_id} - ${rfpo.title} - RFPO Application`;
        
        // Handle approval data for approvers
        if (data.approval_data) {
            displayApprovalChain(data.approval_data);
        }
        
        // Handle user action for approvers
        if (data.user_action && data.user_action.can_take_action) {
            displayUserAction(data.user_action);
        }
        
        // Load files into RFPO Information section
        loadAttachedFiles(data.files || []);
        
        // Load RFPO document view
        loadRfpoDocument();
    }

    function getStatusBadge(status) {
        const statusClasses = {
            'Draft': 'bg-secondary',
            'Pending': 'bg-warning',
            'In Review': 'bg-info',
            'Approved': 'bg-success',
            'Completed': 'bg-success',
            'Rejected': 'bg-danger',
            'Cancelled': 'bg-dark'
        };
        
        const badgeClass = statusClasses[status] || 'bg-secondary';
        return `<span class="badge ${badgeClass}">${status}</span>`;
    }

    function loadAttachedFiles(files) {
        const container = document.getElementById('attachedFiles');
        if (!files || files.length === 0) {
            container.innerHTML = '<span class="text-muted">No files attached</span>';
            return;
        }
        
        // Display files list in RFPO Information section
        const filesList = files.map(file => {
            const fileSize = (file.file_size / 1024).toFixed(1) + ' KB';
            return `
                <div class="d-flex justify-content-between align-items-center py-1">
                    <div>
                        <strong>${file.original_filename}</strong>
                        <br><small class="text-muted">${file.document_type || 'Document'} • ${fileSize}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewFile('${file.file_id}', '${file.original_filename}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = filesList;
    }
    
    function loadRfpoDocument() {
        const container = document.getElementById('rfpoDocumentContainer');
        
        // Load RFPO rendered view via API
        fetch(`/api/rfpos/${rfpoId}/rendered-view`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create RFPO document display using the API data
                    const rfpo = data.rfpo;
                    const project = data.project;
                    const consortium = data.consortium;
                    const vendor = data.vendor;
                    const requestor = data.requestor;
                    
                    const documentHtml = createRfpoDocumentHtml(rfpo, project, consortium, vendor, requestor);
                    container.innerHTML = documentHtml;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                            <p class="mt-2">Error loading RFPO document</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                container.innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p class="mt-2">Error loading document: ${error.message}</p>
                    </div>
                `;
            });
    }
    
    function createRfpoDocumentHtml(rfpo, project, consortium, vendor, requestor) {
        // Create a simplified RFPO document view
        return `
            <div class="p-3" style="font-size: 0.9rem;">
                <div class="text-center mb-3">
                    <h6 class="text-primary">REQUEST FOR PURCHASE ORDER</h6>
                    <h5>${rfpo.rfpo_id}</h5>
                </div>
                
                <div class="mb-3">
                    <strong>Project:</strong> ${project ? project.name : 'Unknown'}<br>
                    <strong>Consortium:</strong> ${consortium ? consortium.name : 'Unknown'}<br>
                    <strong>Title:</strong> ${rfpo.title}
                </div>
                
                <div class="mb-3">
                    <strong>Requestor:</strong> ${requestor ? requestor.display_name : 'Unknown'}<br>
                    <strong>Phone:</strong> ${rfpo.requestor_tel || 'Not provided'}<br>
                    <strong>Location:</strong> ${rfpo.requestor_location || 'Not provided'}
                </div>
                
                <div class="mb-3">
                    <strong>Vendor:</strong> ${vendor ? vendor.company_name : 'Not specified'}<br>
                    <strong>Total Amount:</strong> $${Number(rfpo.total_amount || 0).toLocaleString()}
                </div>
                
                <div class="mb-3">
                    <strong>Description:</strong><br>
                    <div class="border p-2 bg-light">${rfpo.description || 'No description provided'}</div>
                </div>
                
                <div class="mb-3">
                    <strong>Status:</strong> <span class="badge bg-info">${rfpo.status}</span><br>
                    <strong>Created:</strong> ${new Date(rfpo.created_at).toLocaleDateString()}<br>
                    <strong>Created By:</strong> ${rfpo.created_by}
                </div>
            </div>
        `;
    }
    
    function displayApprovalChain(approvalData) {
        const chainSection = document.getElementById('approvalChainSection');
        const chainContent = document.getElementById('approvalChainContent');
        
        if (!approvalData || !approvalData.approval_chain) {
            chainContent.innerHTML = '<p class="text-muted">No approval chain data available</p>';
            return;
        }
        
        const chainHtml = approvalData.approval_chain.map(action => {
            const statusBadge = getActionStatusBadge(action.status);
            const userIndicator = action.is_user_action ? '<i class="fas fa-user text-primary" title="Your action"></i> ' : '';
            
            return `
                <div class="d-flex justify-content-between align-items-center border-bottom py-3">
                    <div>
                        <h6 class="mb-1">${userIndicator}${action.step_name}</h6>
                        <small class="text-muted">${action.stage_name} • ${action.approver_name}</small>
                        ${action.comments ? `<br><small class="text-info">Comments: ${action.comments}</small>` : ''}
                    </div>
                    <div class="text-end">
                        ${statusBadge}
                        ${action.completed_at ? `<br><small class="text-muted">${new Date(action.completed_at).toLocaleDateString()}</small>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        chainContent.innerHTML = chainHtml;
        chainSection.style.display = 'block';
    }
    
    function displayUserAction(userAction) {
        const actionSection = document.getElementById('approvalActionSection');
        
        document.getElementById('actionStepName').textContent = userAction.step_name;
        document.getElementById('actionStageName').textContent = userAction.stage_name;
        
        actionSection.style.display = 'block';
    }
    
    function getActionStatusBadge(status) {
        const statusClasses = {
            'pending': 'bg-warning',
            'approved': 'bg-success',
            'refused': 'bg-danger'
        };
        
        const badgeClass = statusClasses[status] || 'bg-secondary';
        return `<span class="badge ${badgeClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
    }
    
    function viewFile(fileId, filename) {
        // Open file in new tab for viewing
        window.open(`/api/rfpos/${rfpoId}/files/${fileId}/view`, '_blank');
    }
    
    function openRfpoInNewTab() {
        // Open full RFPO document in new tab
        window.open(`/api/rfpos/${rfpoId}/rendered-view`, '_blank');
    }
    
    let currentUserAction = null;
    
    function showApprovalModal(action) {
        currentUserAction = action;
        
        // Create and show modal
        const modalHtml = `
            <div class="modal fade" id="approvalModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${action === 'approved' ? 'Approve' : 'Reject'} RFPO</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <strong>RFPO:</strong> ${currentRfpo.title} (${currentRfpo.rfpo_id})<br>
                                <strong>Your Step:</strong> <span id="modalStepName"></span>
                            </div>
                            <div class="mb-3">
                                <label for="approvalComments" class="form-label">Comments</label>
                                <textarea class="form-control" id="approvalComments" rows="3" 
                                          placeholder="Enter your comments for this ${action} action..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-${action === 'approved' ? 'success' : 'danger'}" onclick="submitApprovalAction()">
                                <i class="fas fa-${action === 'approved' ? 'check' : 'times'}"></i> ${action === 'approved' ? 'Approve' : 'Reject'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('approvalModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Set step name
        document.getElementById('modalStepName').textContent = document.getElementById('actionStepName').textContent;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
        modal.show();
    }
    
    function submitApprovalAction() {
        if (!currentUserAction || !currentRfpo) {
            showAlert('Error: No action selected', 'danger');
            return;
        }
        
        const comments = document.getElementById('approvalComments').value;
        
        // Get user's action ID from the loaded data
        fetch(`/api/rfpos/${rfpoId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.user_action) {
                    const actionId = data.user_action.action_id;
                    
                    // Submit the approval action
                    return fetch(`/api/users/approval-action/${actionId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: currentUserAction,
                            comments: comments
                        })
                    });
                } else {
                    throw new Error('Could not find user action');
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('approvalModal'));
                    modal.hide();
                    
                    // Show success message
                    showAlert(`RFPO ${currentUserAction} successfully!`, 'success');
                    
                    // Reload page to show updated status
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showAlert(`Error: ${data.message}`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`Error: ${error.message}`, 'danger');
            });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadRfpoDetails();
    });
</script>
{% endblock %}
