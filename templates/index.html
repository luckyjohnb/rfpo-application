<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">{{ app_name or 'ACME App' }} - Main Application</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #0f172a;
            --light-color: #f8fafc;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            font-size: 14px;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--gray-900) 0%, var(--gray-800) 100%);
            min-height: 100vh;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 1px solid var(--gray-200);
        }

        /* Mobile responsive sidebar */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 280px;
                height: 100vh;
                z-index: 1050;
                transform: translateX(-100%);
                box-shadow: var(--shadow-lg);
            }
            .sidebar.show {
                transform: translateX(0);
                left: 0;
            }
            .content-area {
                margin-left: 0 !important;
                width: 100% !important;
            }
            .mobile-header {
                display: flex !important;
            }
            .desktop-sidebar-col {
                display: none;
            }
        }

        /* Desktop sidebar */
        @media (min-width: 769px) {
            .mobile-header {
                display: none !important;
            }
        }

        .mobile-header {
            background: white;
            color: var(--gray-900);
            padding: 1rem 1.5rem;
            display: none;
            position: sticky;
            top: 0;
            z-index: 1040;
            border-bottom: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1040;
            backdrop-filter: blur(4px);
        }

        .nav-link {
            color: var(--gray-300) !important;
            border-radius: var(--border-radius-sm);
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            border: none;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white !important;
            transform: translateX(4px);
        }

        .nav-link.active {
            background-color: var(--primary-color);
            color: white !important;
            box-shadow: var(--shadow);
        }

        /* Collapsible Navigation Styles */
        .nav-item-parent {
            position: relative;
        }

        .nav-link-parent {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .nav-chevron {
            transition: transform 0.2s ease;
            font-size: 12px;
        }

        .nav-item-parent.expanded .nav-chevron {
            transform: rotate(90deg);
        }

        .nav-submenu {
            overflow: hidden;
            transition: max-height 0.3s ease;
            max-height: 0;
        }

        .nav-item-parent.expanded .nav-submenu {
            max-height: 500px;
        }

        .nav-sublink {
            color: var(--gray-400) !important;
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            font-size: 14px;
            border-radius: var(--border-radius-sm);
            margin: 0.125rem 0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            text-decoration: none;
            font-weight: 500;
        }

        .nav-sublink i {
            width: 16px;
            text-align: center;
            margin-right: 0.5rem;
            font-size: 14px;
        }

        .nav-sublink:hover {
            background-color: rgba(255, 255, 255, 0.08);
            color: white !important;
            transform: translateX(4px);
        }

        .nav-sublink.active {
            background-color: rgba(37, 99, 235, 0.6);
            color: white !important;
        }

        .content-area {
            background-color: var(--gray-50);
            min-height: 100vh;
            padding: 2rem;
        }

        .login-card {
            max-width: 420px;
            margin: 2rem auto;
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 1.5rem;
        }

        .feature-box {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--gray-200);
        }

        /* Responsive feature box */
        @media (max-width: 768px) {
            .feature-box {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            .content-area {
                padding: 1rem;
            }
        }

        .feature-box:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* RFPO Stat Cards */
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius);
            background: rgba(37, 99, 235, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .stat-icon i {
            font-size: 1.5rem;
        }

        /* Responsive stat cards */
        @media (max-width: 768px) {
            .stat-card {
                margin-bottom: 1rem;
                padding: 1rem;
            }
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: var(--success-color); }
        .status-offline { background-color: var(--danger-color); }

        /* Modern buttons */
        .btn {
            border-radius: var(--border-radius-sm);
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            padding: 0.75rem 1.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-outline-light {
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-outline-danger {
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
            background: transparent;
        }

        .btn-outline-danger:hover {
            background-color: var(--danger-color);
            color: white;
        }

        /* Modern form controls */
        .form-control {
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            padding: 0.75rem 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        /* Modern badges */
        .badge {
            border-radius: var(--border-radius-sm);
            font-weight: 500;
            padding: 0.5rem 0.75rem;
        }

        .badge.bg-success {
            background-color: var(--success-color) !important;
        }

        .badge.bg-primary {
            background-color: var(--primary-color) !important;
        }

        .badge.bg-warning {
            background-color: var(--warning-color) !important;
            color: var(--gray-900) !important;
        }

        .badge.bg-danger {
            background-color: var(--danger-color) !important;
        }

        .badge.bg-info {
            background-color: var(--primary-light) !important;
        }

        /* Modern alerts */
        .alert {
            border: none;
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .alert-success {
            background-color: #ecfdf5;
            color: #065f46;
            border-left: 4px solid var(--success-color);
        }

        .alert-danger {
            background-color: #fef2f2;
            color: #991b1b;
            border-left: 4px solid var(--danger-color);
        }

        .alert-warning {
            background-color: #fffbeb;
            color: #92400e;
            border-left: 4px solid var(--warning-color);
        }

        .alert-info {
            background-color: #eff6ff;
            color: #1e40af;
            border-left: 4px solid var(--primary-color);
        }

        /* Responsive table */
        .table {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            margin-bottom: 0;
        }

        .table th {
            background-color: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-700);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem 0.75rem;
        }

        .table td {
            border-bottom: 1px solid var(--gray-100);
            padding: 1rem 0.75rem;
            color: var(--gray-600);
        }

        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
                word-break: break-word;
            }
            .btn-sm {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
        }

        /* Responsive form layouts */
        @media (max-width: 768px) {
            .user-management-row {
                flex-direction: column;
            }
            .user-list-col {
                order: 2;
                margin-top: 1rem;
            }
            .create-user-col {
                order: 1;
            }
        }

        /* Typography improvements */
        h1, h2, h3, h4, h5, h6 {
            color: var(--gray-900);
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        h2 {
            font-size: 1.875rem;
            margin-bottom: 1.5rem;
        }

        h5 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }

        .text-muted {
            color: var(--gray-500) !important;
        }

        .text-gray-300 {
            color: var(--gray-300) !important;
        }

        .text-gray-400 {
            color: var(--gray-400) !important;
        }

        /* Icon improvements */
        .fas {
            color: inherit;
        }

        /* Loading spinner */
        .fa-spinner {
            color: var(--primary-color);
        }

        /* Modern scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* Apple SMS-style Chat Interface */
        .chat-container {
            height: 75vh;
            max-height: 650px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            background: #f2f2f7;
            border: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 0.75rem;
        }

        .chat-header .info h6 {
            margin: 0;
            font-weight: 600;
            color: var(--gray-900);
        }

        .chat-header .info small {
            color: var(--success-color);
            font-size: 12px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f2f2f7;
            min-height: 0;
        }

        .message {
            display: flex;
            margin-bottom: 1rem;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user .message-bubble {
            background: #007aff;
            color: white;
            border-bottom-right-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 122, 255, 0.3);
        }

        .message.bot .message-bubble {
            background: white;
            color: var(--gray-900);
            border-bottom-left-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
        }

        .message-time {
            font-size: 11px;
            color: var(--gray-500);
            margin-top: 0.25rem;
            text-align: right;
        }

        .message.bot .message-time {
            text-align: left;
        }

        .chat-input-container {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--gray-200);
        }

        .chat-input-group {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .chat-input-group .d-flex {
            width: 100%;
        }

        .chat-input {
            flex: 1;
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            padding: 0.75rem 1rem;
            max-height: 100px;
            resize: none;
            font-size: 14px;
            line-height: 1.4;
            transition: all 0.2s ease;
        }

        .chat-input:focus {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            outline: none;
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007aff;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .chat-send-btn:hover {
            background: #0056d6;
            transform: scale(1.05);
        }

        .chat-send-btn:disabled {
            background: var(--gray-400);
            transform: none;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            color: var(--gray-500);
            font-style: italic;
            font-size: 13px;
        }

        /* File Upload Styles */
        .chat-file-upload {
            background: var(--gray-50);
            border: 1px dashed var(--gray-300);
            border-radius: var(--border-radius-sm);
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 12px;
        }

        .chat-file-upload:hover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
        }

        .chat-file-upload.dragover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }

        .file-attachments {
            display: none;
            max-height: 80px;
            overflow-y: auto;
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            background: var(--gray-50);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--gray-200);
        }

        .file-attachment {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-sm);
            font-size: 11px;
        }

        .file-attachment:last-child {
            margin-bottom: 0;
        }

        .file-attachment .file-info {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .file-attachment .file-icon {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
            font-size: 10px;
            color: white;
            flex-shrink: 0;
        }

        .file-attachment .file-icon.pdf { background: #dc3545; }
        .file-attachment .file-icon.doc { background: #0066cc; }
        .file-attachment .file-icon.txt { background: var(--gray-600); }
        .file-attachment .file-icon.image { background: var(--success-color); }
        .file-attachment .file-icon.default { background: var(--gray-500); }

        .file-attachment .file-details {
            flex: 1;
            min-width: 0;
        }

        .file-attachment .file-name {
            font-weight: 500;
            color: var(--gray-900);
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-attachment .file-size {
            color: var(--gray-500);
            font-size: 10px;
        }

        .file-attachment .remove-file {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0.125rem;
            border-radius: 50%;
            transition: all 0.2s ease;
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-attachment .remove-file:hover {
            color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
        }

        .chat-input-container {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--gray-200);
            flex-shrink: 0;
        }

        .message-attachment {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--primary-color);
        }

        .message-attachment .attachment-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .message-attachment .attachment-icon {
            width: 16px;
            height: 16px;
            margin-right: 0.5rem;
        }

        .message-attachment .attachment-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .message-attachment .attachment-content {
            font-size: 11px;
            color: var(--gray-600);
            margin-top: 0.25rem;
            max-height: 100px;
            overflow-y: auto;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--gray-400);
            margin: 0 1px;
            animation: typingDots 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDots {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-settings {
            margin-bottom: 1.5rem;
        }

        .langflow-config {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 1rem;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 65vh;
                max-height: 500px;
            }

            .message-bubble {
                max-width: 85%;
            }

            .chat-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .file-attachment .file-name {
                font-size: 10px;
            }

            .file-attachment .file-size {
                font-size: 9px;
            }

            .chat-input-container {
                padding: 0.5rem;
            }
        }

        /* User Dropdown Styles */
        .user-dropdown {
            position: relative;
        }

        .user-dropdown-toggle {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--gray-700);
            font-size: 14px;
            font-weight: 500;
            min-width: 150px;
        }

        .user-dropdown-toggle:hover {
            background: var(--gray-100);
            border-color: var(--gray-300);
            color: var(--gray-900);
        }

        .user-dropdown-toggle.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .user-avatar.guest {
            background: var(--gray-400);
        }

        .user-info {
            flex: 1;
            text-align: left;
        }

        .user-name {
            font-weight: 600;
            line-height: 1.2;
        }

        .user-role {
            font-size: 11px;
            opacity: 0.8;
            line-height: 1;
        }

        .dropdown-chevron {
            transition: transform 0.2s ease;
            font-size: 12px;
        }

        .user-dropdown.show .dropdown-chevron {
            transform: rotate(180deg);
        }

        .user-dropdown-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            z-index: 1050;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .user-dropdown.show .user-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-100);
            background: var(--gray-50);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .dropdown-header .user-details {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dropdown-header .user-avatar {
            width: 36px;
            height: 36px;
            font-size: 14px;
        }

        .dropdown-header .user-info .user-name {
            font-size: 14px;
            color: var(--gray-900);
            margin: 0;
        }

        .dropdown-header .user-info .user-role {
            font-size: 12px;
            color: var(--gray-500);
            margin: 0;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--gray-700);
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .dropdown-item i {
            width: 16px;
            text-align: center;
            color: var(--gray-500);
        }

        .dropdown-item.danger {
            color: var(--danger-color);
        }

        .dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--gray-100);
            margin: 0.25rem 0;
        }

        @media (max-width: 768px) {
            .user-dropdown-toggle {
                min-width: auto;
                padding: 0.5rem;
            }

            .user-info {
                display: none;
            }

            .user-dropdown-menu {
                right: 0;
                left: auto;
                min-width: 200px;
            }
        }

        /* Navigation Editor Styles */
        .navigation-editor {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 1rem;
        }

        .menu-items-list {
            min-height: 300px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius-sm);
            padding: 0.5rem;
        }

        .menu-item-editor {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius-sm);
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            transition: all 0.2s;
            cursor: move;
            position: relative;
        }

        .menu-item-editor:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--primary-color);
        }

        .menu-item-editor.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            z-index: 1000;
        }

        .menu-item-editor.drag-over {
            border-top: 3px solid var(--primary-color);
        }

        .menu-item-header {
            display: flex;
            align-items: center;
            justify-content: between;
            gap: 0.5rem;
        }

        .menu-item-icon {
            width: 20px;
            text-align: center;
            color: var(--gray-600);
        }

        .menu-item-label {
            flex: 1;
            font-weight: 500;
            color: var(--gray-900);
        }

        .menu-item-controls {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .menu-item-editor:hover .menu-item-controls {
            opacity: 1;
        }

        .menu-item-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .menu-item-btn:hover {
            transform: translateY(-1px);
        }

        .menu-item-btn.edit {
            background: #fff3cd;
            color: #856404;
        }

        .menu-item-btn.edit:hover {
            background: #ffeaa7;
        }

        .menu-item-btn.toggle {
            background: #d1ecf1;
            color: #0c5460;
        }

        .menu-item-btn.toggle:hover {
            background: #bee5eb;
        }

        .menu-item-btn.delete {
            background: #f8d7da;
            color: #721c24;
        }

        .menu-item-btn.delete:hover {
            background: #f5c6cb;
        }

        .menu-item-submenu {
            margin-left: 1.5rem;
            margin-top: 0.5rem;
            padding-left: 0.75rem;
            border-left: 2px solid #e9ecef;
        }

        .menu-item-hidden {
            opacity: 0.5;
            background: #f8f9fa;
        }

        .menu-item-hidden .menu-item-label {
            text-decoration: line-through;
            color: var(--gray-500);
        }

        .role-badges {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .role-badge {
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-badge:hover {
            transform: scale(1.05);
        }

        .role-badge.active {
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary-color);
        }

        .editor-toolbar {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius-sm);
            padding: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .menu-item-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .meta-badge {
            background: var(--gray-200);
            color: var(--gray-700);
            padding: 0.125rem 0.375rem;
            border-radius: 12px;
            font-size: 0.7rem;
        }

        .meta-badge.roles {
            background: #e7f3ff;
            color: #0969da;
        }

        .drag-handle {
            cursor: grab;
            color: var(--gray-400);
            margin-right: 0.5rem;
        }

        .drag-handle:hover {
            color: var(--gray-600);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .menu-item-editor.new {
            animation: slideDown 0.3s ease-out;
        }
    </style>
</head>
<body>
    <!-- Mobile Header (hidden on desktop) -->
    <div class="mobile-header d-md-none">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-users-cog fs-4 me-2" style="color: var(--primary-color);"></i>
                <h5 class="mb-0 fw-bold" data-app-name>{{ app_name or 'Flask App' }}</h5>
            </div>
            <div class="d-flex align-items-center gap-2">
                <!-- Mobile User Dropdown -->
                <div class="user-dropdown" id="mobileUserDropdown">
                    <div class="user-dropdown-toggle" onclick="toggleUserDropdown()" style="min-width: auto; padding: 0.5rem;">
                        <div class="user-avatar guest" id="mobileUserAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="toggleMobileSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 p-0 desktop-sidebar-col">
                <div class="sidebar p-3" id="sidebar">
                    <div class="d-flex align-items-center mb-4">
                        <div class="d-flex align-items-center justify-content-center me-3"
                             style="width: 40px; height: 40px; background: var(--primary-color); border-radius: var(--border-radius-sm);">
                            <i class="fas fa-users-cog text-white"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 text-white fw-bold" data-app-name>{{ app_name or 'Flask App' }}</h5>
                            <small class="text-gray-400">User Management</small>
                        </div>
                        <!-- Close button for mobile -->
                        <button class="btn btn-outline-light btn-sm ms-auto d-md-none" onclick="closeMobileSidebar()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white active" href="#" onclick="showSection('dashboard'); return false;">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white" href="#" onclick="showSection('auth'); return false;">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                Authentication
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white" href="#" onclick="showSection('upload'); return false;">
                                <i class="fas fa-file-upload me-2"></i>
                                File Upload
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white" href="#" onclick="showSection('users'); return false;">
                                <i class="fas fa-users me-2"></i>
                                User Management
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white" href="#" onclick="openChatSection(); return false;">
                                <i class="fas fa-comments me-2"></i>
                                AI Assistant
                            </a>
                        </li>
                        <!-- Applications Menu with Submenu -->
                        <li class="nav-item mb-2 nav-item-parent expanded" id="appsNavParent">
                            <a class="nav-link text-white nav-link-parent" href="#" onclick="toggleAppsMenu(); return false;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-th-large me-2"></i>
                                    Applications
                                </div>
                                <i class="fas fa-chevron-right nav-chevron"></i>
                            </a>
                            <div class="nav-submenu" style="max-height: none !important; display: block !important;">
                                <a class="nav-sublink text-white" href="#" onclick="showSection('rfpo-app'); return false;">
                                    <i class="fas fa-clipboard-list"></i>
                                    RFPO
                                </a>
                                <a class="nav-sublink text-white" href="#" onclick="showSection('wbs-app'); return false;">
                                    <i class="fas fa-project-diagram"></i>
                                    WBS APP
                                </a>
                            </div>
                        </li>
                        <!-- Configuration Menu with Submenu -->
                        <li class="nav-item mb-2 nav-item-parent expanded" id="configNavParent">
                            <a class="nav-link text-white nav-link-parent" href="#" onclick="toggleConfigMenu(); return false;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-cog me-2"></i>
                                    Configuration
                                </div>
                                <i class="fas fa-chevron-right nav-chevron"></i>
                            </a>
                            <div class="nav-submenu" style="max-height: none !important; display: block !important;">
                                <a class="nav-sublink text-white" href="#" onclick="showSection('app-settings'); return false;">
                                    <i class="fas fa-sliders-h"></i>
                                    Application Settings
                                </a>
                                <a class="nav-sublink text-white" href="#" onclick="showSection('ai-config'); return false;">
                                    <i class="fas fa-robot"></i>
                                    AI Configuration
                                </a>
                                <a class="nav-sublink text-white" href="#" onclick="showSection('file-config'); return false;">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    File Upload Configuration
                                </a>
                                <a class="nav-sublink text-white" href="#" onclick="showSection('nav-editor'); return false;">
                                    <i class="fas fa-edit"></i>
                                    Navigation Editor
                                </a>
                            </div>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white" href="#" onclick="testAPI(); return false;">
                                <i class="fas fa-flask me-2"></i>
                                Test API
                            </a>
                        </li>
                    </ul>

                    <hr class="my-4" style="border-color: rgba(255, 255, 255, 0.1);">

                    <div class="px-2">
                        <div class="d-flex align-items-center mb-3">
                            <span class="status-indicator status-online"></span>
                            <small class="text-gray-300">Server Online</small>
                        </div>
                        <div class="text-gray-400" style="font-size: 12px;">
                            <div class="mb-1" data-app-version>Version {{ app_version or '2.0' }}</div>
                            <div data-app-name>Â© 2025 {{ app_name or 'Flask App' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 content-area p-4">
                <!-- Top Navigation Bar -->
                <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-primary btn-sm d-md-none me-3" onclick="toggleMobileSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="h4 mb-0 text-dark fw-bold" data-app-name>{{ app_name or 'ACME App' }}</h1>
                            <small class="text-muted">Main Application Interface</small>
                        </div>
                    </div>

                    <!-- User Dropdown -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-toggle" onclick="toggleUserDropdown()">
                            <div class="user-avatar guest" id="userAvatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-info d-none d-sm-block">
                                <div class="user-name" id="userName">Guest User</div>
                                <div class="user-role" id="userRole">Not Authenticated</div>
                            </div>
                            <i class="fas fa-chevron-down dropdown-chevron"></i>
                        </div>

                        <div class="user-dropdown-menu" id="userDropdownMenu">
                            <!-- Guest State Menu -->
                            <div id="guestMenu">
                                <div class="dropdown-header">
                                    <div class="user-details">
                                        <div class="user-avatar guest">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="user-info">
                                            <div class="user-name">Guest User</div>
                                            <div class="user-role">Not Authenticated</div>
                                        </div>
                                    </div>
                                </div>
                                <button class="dropdown-item" onclick="showSection('auth'); closeUserDropdown();">
                                    <i class="fas fa-sign-in-alt"></i>
                                    Login / Authenticate
                                </button>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item" onclick="testAPI(); closeUserDropdown();">
                                    <i class="fas fa-cog"></i>
                                    API Status
                                </button>
                            </div>

                            <!-- Authenticated User Menu -->
                            <div id="authenticatedMenu" style="display: none;">
                                <div class="dropdown-header">
                                    <div class="user-details">
                                        <div class="user-avatar" id="authUserAvatar">
                                            <span id="authUserInitials">U</span>
                                        </div>
                                        <div class="user-info">
                                            <div class="user-name" id="authUserName">User Name</div>
                                            <div class="user-role" id="authUserRole">user</div>
                                        </div>
                                    </div>
                                </div>
                                <button class="dropdown-item" onclick="showSection('users'); closeUserDropdown();" id="userMgmtMenuItem" style="display: none;">
                                    <i class="fas fa-users-cog"></i>
                                    User Management
                                </button>
                                <button class="dropdown-item" onclick="showSection('auth'); closeUserDropdown();">
                                    <i class="fas fa-user-edit"></i>
                                    Switch User
                                </button>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item" onclick="testAPI(); closeUserDropdown();">
                                    <i class="fas fa-cog"></i>
                                    API Status
                                </button>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item danger" onclick="logoutUser(); closeUserDropdown();">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Section -->
                <div id="dashboard" class="content-section">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <div>
                            <h2 class="mb-1"><i class="fas fa-tachometer-alt me-2" style="color: var(--primary-color);"></i>Application Dashboard</h2>
                            <p class="text-muted mb-0">Monitor your Flask application status and metrics</p>
                        </div>
                        <a href="/" class="btn btn-outline-primary">
                            <i class="fas fa-home me-1"></i>
                            Back to Landing
                        </a>
                    </div>

                    <div class="row">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="feature-box text-center">
                                <div class="d-flex align-items-center justify-content-center mb-3"
                                     style="width: 60px; height: 60px; background: rgba(37, 99, 235, 0.1); border-radius: var(--border-radius); margin: 0 auto;">
                                    <i class="fas fa-server fs-3" style="color: var(--primary-color);"></i>
                                </div>
                                <h5 class="fw-bold">Server Status</h5>
                                <p class="text-muted mb-3">Flask application is running successfully</p>
                                <span class="badge bg-success">Online</span>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="feature-box text-center">
                                <div class="d-flex align-items-center justify-content-center mb-3"
                                     style="width: 60px; height: 60px; background: rgba(16, 185, 129, 0.1); border-radius: var(--border-radius); margin: 0 auto;">
                                    <i class="fas fa-shield-alt fs-3" style="color: var(--success-color);"></i>
                                </div>
                                <h5 class="fw-bold">Security</h5>
                                <p class="text-muted mb-3">JWT authentication enabled</p>
                                <span class="badge bg-info">Active</span>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-12 mb-3">
                            <div class="feature-box text-center">
                                <div class="d-flex align-items-center justify-content-center mb-3"
                                     style="width: 60px; height: 60px; background: rgba(245, 158, 11, 0.1); border-radius: var(--border-radius); margin: 0 auto;">
                                    <i class="fas fa-database fs-3" style="color: var(--warning-color);"></i>
                                </div>
                                <h5 class="fw-bold">Data Processing</h5>
                                <p class="text-muted mb-3">Pandas integration available</p>
                                <span class="badge bg-warning">Ready</span>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="feature-box">
                                <div class="d-flex align-items-center mb-4">
                                    <div class="d-flex align-items-center justify-content-center me-3"
                                         style="width: 40px; height: 40px; background: rgba(37, 99, 235, 0.1); border-radius: var(--border-radius-sm);">
                                        <i class="fas fa-info-circle" style="color: var(--primary-color);"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-1 fw-bold">Quick Start Guide</h5>
                                        <p class="text-muted mb-0">Explore the key features of this application</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <h6 class="fw-bold mb-3" style="color: var(--gray-700);">ð Authentication Features</h6>
                                            <ul class="list-unstyled">
                                                <li class="mb-2 d-flex align-items-start">
                                                    <i class="fas fa-check-circle me-2 mt-1" style="color: var(--success-color); font-size: 12px;"></i>
                                                    <span>JWT-based secure authentication</span>
                                                </li>
                                                <li class="mb-2 d-flex align-items-start">
                                                    <i class="fas fa-check-circle me-2 mt-1" style="color: var(--success-color); font-size: 12px;"></i>
                                                    <span>Role-based access control (RBAC)</span>
                                                </li>
                                                <li class="mb-2 d-flex align-items-start">
                                                    <i class="fas fa-check-circle me-2 mt-1" style="color: var(--success-color); font-size: 12px;"></i>
                                                    <span>Password complexity requirements</span>
                                                </li>
                                                <li class="mb-2 d-flex align-items-start">
                                                    <i class="fas fa-check-circle me-2 mt-1" style="color: var(--success-color); font-size: 12px;"></i>
                                                    <span>Account lockout protection</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <h6 class="fw-bold mb-3" style="color: var(--gray-700);">ð Application Features</h6>
                                            <ul class="list-unstyled">
                                                <li class="mb-2 d-flex align-items-start">
                                                    <i class="fas fa-check-circle me-2 mt-1" style="color: var(--success-color); font-size: 12px;"></i>
                                                    <span>File upload and processing</span>
                                                </li>
                                                <li class="mb-2 d-flex align-items-start">
                                                    <i class="fas fa-check-circle me-2 mt-1" style="color: var(--success-color); font-size: 12px;"></i>
                                                    <span>User management dashboard</span>
                                                </li>
                                                <li class="mb-2 d-flex align-items-start">
                                                    <i class="fas fa-check-circle me-2 mt-1" style="color: var(--success-color); font-size: 12px;"></i>
                                                    <span>Data export capabilities</span>
                                                </li>
                                                <li class="mb-2 d-flex align-items-start">
                                                    <i class="fas fa-check-circle me-2 mt-1" style="color: var(--success-color); font-size: 12px;"></i>
                                                    <span>Comprehensive audit logging</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Authentication Section -->
                <div id="auth" class="content-section" style="display: none;">
                    <div class="mb-4">
                        <h2 class="mb-1"><i class="fas fa-sign-in-alt me-2" style="color: var(--primary-color);"></i>Authentication Demo</h2>
                        <p class="text-muted mb-0">Test the JWT-based authentication system</p>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card login-card">
                                <div class="card-header text-center">
                                    <h5>Login Demo</h5>
                                </div>
                                <div class="card-body">
                                    <form id="loginForm">
                                        <div class="mb-3">
                                            <label for="username" class="form-label">Username</label>
                                            <input type="text" class="form-control" id="username" value="admin" placeholder="Enter username">
                                        </div>
                                        <div class="mb-3">
                                            <label for="password" class="form-label">Password</label>
                                            <input type="password" class="form-control" id="password" value="Administrator123!" placeholder="Enter password">
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-sign-in-alt me-1"></i>
                                                Login
                                            </button>
                                        </div>
                                    </form>
                                    <div id="authResult" class="mt-3"></div>
                                    <div class="text-center mt-3">
                                        <small class="text-muted">
                                            Default credentials: admin / Administrator123!<br>
                                            (Run <code>python init_admin.py</code> first)
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div id="upload" class="content-section" style="display: none;">
                    <div class="mb-4">
                        <h2 class="mb-1"><i class="fas fa-file-upload me-2" style="color: var(--primary-color);"></i>File Upload Demo</h2>
                        <p class="text-muted mb-0">Upload and process CSV/Excel files with automatic data validation</p>
                    </div>
                    <div class="feature-box">
                        <div class="row">
                            <div class="col-lg-6 col-md-12 mb-3">
                                <h5>Upload CSV/Excel File</h5>
                                <form id="uploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <input type="file" class="form-control" id="fileInput" accept=".csv,.xlsx,.xls">
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-upload me-1"></i>
                                        Upload File
                                    </button>
                                </form>
                                <div id="uploadResult" class="mt-3"></div>
                            </div>
                            <div class="col-lg-6 col-md-12">
                                <h6>Supported Formats:</h6>
                                <ul>
                                    <li>CSV files (.csv)</li>
                                    <li>Excel files (.xlsx, .xls)</li>
                                </ul>
                                <h6>Features:</h6>
                                <ul>
                                    <li>Automatic data processing</li>
                                    <li>Data validation and cleaning</li>
                                    <li>Export capabilities</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div id="users" class="content-section" style="display: none;">
                    <div class="mb-4">
                        <h2 class="mb-1"><i class="fas fa-users me-2" style="color: var(--primary-color);"></i>User Management</h2>
                        <p class="text-muted mb-0">Manage user accounts, roles, and permissions</p>
                    </div>

                    <!-- Authentication Check -->
                    <div id="userMgmtAuth" class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Please login first to access user management features.
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="showSection('auth'); return false;">
                            <i class="fas fa-sign-in-alt me-1"></i>
                            Go to Login
                        </button>
                    </div>

                    <!-- User Management Interface (shown after login) -->
                    <div id="userMgmtInterface" style="display: none;">
                        <div class="row user-management-row">
                            <!-- Create User -->
                            <div class="col-md-4 create-user-col">
                                <div class="feature-box">
                                    <h5><i class="fas fa-user-plus me-2"></i>Create New User</h5>
                                    <form id="createUserForm">
                                        <div class="mb-3">
                                            <label for="newUsername" class="form-label">Username</label>
                                            <input type="text" class="form-control" id="newUsername" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">Password</label>
                                            <input type="password" class="form-control" id="newPassword" required>
                                            <div class="form-text">Min 8 chars, 1 upper, 1 lower, 1 number</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newDisplayName" class="form-label">Display Name</label>
                                            <input type="text" class="form-control" id="newDisplayName">
                                        </div>
                                        <div class="mb-3">
                                            <label for="newEmail" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="newEmail">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Roles</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="roleUser" value="user" checked>
                                                <label class="form-check-label" for="roleUser">User</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="roleAdmin" value="admin">
                                                <label class="form-check-label" for="roleAdmin">Admin</label>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-success btn-sm w-100">
                                            <i class="fas fa-user-plus me-1"></i>
                                            Create User
                                        </button>
                                    </form>
                                    <div id="createUserResult" class="mt-3"></div>
                                </div>
                            </div>

                            <!-- User List -->
                            <div class="col-md-8 user-list-col">
                                <div class="feature-box">
                                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>All Users</h5>
                                        <button class="btn btn-primary btn-sm" onclick="loadUsers()">
                                            <i class="fas fa-sync me-1"></i>
                                            Refresh
                                        </button>
                                    </div>
                                    <div id="usersList">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            Loading users...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Assistant Section -->
                <div id="chat" class="content-section" style="display: none;">
                    <div class="mb-4">
                        <h2 class="mb-1"><i class="fas fa-comments me-2" style="color: var(--primary-color);"></i>AI Assistant</h2>
                        <p class="text-muted mb-0">Chat with an intelligent AI assistant powered by Langflow</p>
                    </div>

                    <!-- Chat Interface -->
                    <div class="row">
                        <div class="col-12">
                            <div class="chat-container">
                                <!-- Chat Header -->
                                <div class="chat-header">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div class="info">
                                            <h6>AI Assistant</h6>
                                            <small id="chatStatus">Online</small>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-success me-2" id="modelBadge">GPT-3.5</span>
                                        <button class="btn btn-outline-info btn-sm me-1" onclick="showDebugInfo()" title="Debug Connection">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="showSection('ai-config')" title="AI Configuration">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Chat Messages -->
                                <div class="chat-messages" id="chatMessages">
                                    <div class="message bot">
                                        <div class="message-bubble">
                                            ð Hello! I'm your AI assistant. I'm here to help you with any questions or tasks you might have. What can I do for you today?
                                            <div class="message-time" id="welcomeTime"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Typing Indicator -->
                                <div class="typing-indicator" id="typingIndicator">
                                    <div class="typing-dots">
                                        AI is thinking<span>.</span><span>.</span><span>.</span>
                                    </div>
                                </div>

                                <!-- Chat Input -->
                                <div class="chat-input-container">
                                    <!-- File Attachments Display -->
                                    <div class="file-attachments" id="fileAttachments"></div>

                                    <div class="chat-input-group">
                                        <div class="d-flex align-items-end gap-2">
                                            <!-- File Upload Button -->
                                            <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('chatFileInput').click()" title="Attach files">
                                                <i class="fas fa-paperclip"></i>
                                            </button>
                                            <input type="file" id="chatFileInput" multiple accept=".txt,.pdf,.doc,.docx,.csv,.json,.md" style="display: none;">

                                            <textarea class="chat-input flex-fill" id="chatInput"
                                                      placeholder="Type your message..."
                                                      rows="1"
                                                      onkeydown="handleChatKeydown(event)"
                                                      oninput="autoResizeTextarea(this)"></textarea>
                                            <button class="chat-send-btn" id="sendButton" onclick="sendMessage()">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Compact File Upload Area (shown on demand) -->
                                    <div class="chat-file-upload" id="fileUploadArea" style="display: none;">
                                        <i class="fas fa-cloud-upload-alt me-2" style="color: var(--gray-500);"></i>
                                        <span style="color: var(--gray-600);">Drop files here or click attach button</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Application Settings Section -->
                <div id="app-settings" class="content-section" style="display: none;">
                    <div class="mb-4">
                        <h2 class="mb-1"><i class="fas fa-sliders-h me-2" style="color: var(--primary-color);"></i>Application Settings</h2>
                        <p class="text-muted mb-0">Configure application-wide settings and variables</p>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <!-- Settings Actions -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <button class="btn btn-primary" onclick="loadApplicationSettings()">
                                        <i class="fas fa-sync me-2"></i>Reload Settings
                                    </button>
                                    <button class="btn btn-success ms-2" onclick="saveApplicationSettings()">
                                        <i class="fas fa-save me-2"></i>Save Changes
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-outline-warning" onclick="resetApplicationSettings()">
                                        <i class="fas fa-undo me-2"></i>Reset to Defaults
                                    </button>
                                </div>
                            </div>

                            <!-- Settings Status -->
                            <div id="settings-status" class="mb-3" style="display: none;"></div>

                            <!-- Settings Tabs -->
                            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="identity-tab" data-bs-toggle="tab" data-bs-target="#identity-panel" type="button" role="tab">
                                        <i class="fas fa-id-card me-2"></i>Application Identity
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="ui-tab" data-bs-toggle="tab" data-bs-target="#ui-panel" type="button" role="tab">
                                        <i class="fas fa-palette me-2"></i>User Interface
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security-panel" type="button" role="tab">
                                        <i class="fas fa-shield-alt me-2"></i>Security
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system-panel" type="button" role="tab">
                                        <i class="fas fa-cogs me-2"></i>System
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-panel" type="button" role="tab">
                                        <i class="fas fa-code me-2"></i>Advanced
                                    </button>
                                </li>
                            </ul>

                            <!-- Settings Tab Content -->
                            <div class="tab-content" id="settingsTabContent">
                                <!-- Application Identity Panel -->
                                <div class="tab-pane fade show active" id="identity-panel" role="tabpanel">
                                    <div class="feature-box mt-3">
                                        <h5 class="mb-4"><i class="fas fa-id-card me-2"></i>Application Identity</h5>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="application_name" class="form-label">Application Name <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="application_name" name="application_name" required>
                                                    <div class="form-text">The name displayed throughout the application</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="application_version" class="form-label">Application Version</label>
                                                    <input type="text" class="form-control" id="application_version" name="application_version" pattern="^\d+\.\d+(\.\d+)?$">
                                                    <div class="form-text">Version number (e.g., 2.1.0)</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="company_name" class="form-label">Company Name</label>
                                                    <input type="text" class="form-control" id="company_name" name="company_name">
                                                    <div class="form-text">Organization using this application</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="application_description" class="form-label">Application Description</label>
                                            <textarea class="form-control" id="application_description" name="application_description" rows="3" maxlength="500"></textarea>
                                            <div class="form-text">Brief description of the application purpose</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- User Interface Panel -->
                                <div class="tab-pane fade" id="ui-panel" role="tabpanel">
                                    <div class="feature-box mt-3">
                                        <h5 class="mb-4"><i class="fas fa-palette me-2"></i>User Interface Settings</h5>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="theme_color" class="form-label">Theme Color</label>
                                                    <input type="color" class="form-control form-control-color" id="theme_color" name="theme_color">
                                                    <div class="form-text">Primary color for the application theme</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="items_per_page" class="form-label">Items Per Page</label>
                                                    <select class="form-select" id="items_per_page" name="items_per_page">
                                                        <option value="5">5</option>
                                                        <option value="10">10</option>
                                                        <option value="20">20</option>
                                                        <option value="50">50</option>
                                                        <option value="100">100</option>
                                                    </select>
                                                    <div class="form-text">Default number of items to show per page</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="sidebar_width" class="form-label">Sidebar Width (px)</label>
                                                    <input type="number" class="form-control" id="sidebar_width" name="sidebar_width" min="200" max="400">
                                                    <div class="form-text">Width of the navigation sidebar</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check mt-4">
                                                    <input class="form-check-input" type="checkbox" id="enable_dark_mode" name="enable_dark_mode">
                                                    <label class="form-check-label" for="enable_dark_mode">
                                                        Enable Dark Mode
                                                    </label>
                                                    <div class="form-text">Allow users to switch to dark theme</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Security Panel -->
                                <div class="tab-pane fade" id="security-panel" role="tabpanel">
                                    <div class="feature-box mt-3">
                                        <h5 class="mb-4"><i class="fas fa-shield-alt me-2"></i>Security Settings</h5>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="session_timeout_hours" class="form-label">Session Timeout (Hours)</label>
                                                    <input type="number" class="form-control" id="session_timeout_hours" name="session_timeout_hours" min="1" max="168">
                                                    <div class="form-text">Hours before user sessions expire</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="password_min_length" class="form-label">Minimum Password Length</label>
                                                    <input type="number" class="form-control" id="password_min_length" name="password_min_length" min="8" max="50">
                                                    <div class="form-text">Minimum required password length</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="login_attempt_limit" class="form-label">Login Attempt Limit</label>
                                                    <input type="number" class="form-control" id="login_attempt_limit" name="login_attempt_limit" min="3" max="10">
                                                    <div class="form-text">Maximum failed login attempts</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="account_lockout_minutes" class="form-label">Account Lockout (Minutes)</label>
                                                    <input type="number" class="form-control" id="account_lockout_minutes" name="account_lockout_minutes" min="5" max="1440">
                                                    <div class="form-text">Minutes to lock account after failed attempts</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="require_strong_passwords" name="require_strong_passwords">
                                                    <label class="form-check-label" for="require_strong_passwords">
                                                        Require Strong Passwords
                                                    </label>
                                                    <div class="form-text">Enforce password complexity rules</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- System Panel -->
                                <div class="tab-pane fade" id="system-panel" role="tabpanel">
                                    <div class="feature-box mt-3">
                                        <h5 class="mb-4"><i class="fas fa-cogs me-2"></i>System Settings</h5>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="max_file_size_mb" class="form-label">Max File Size (MB)</label>
                                                    <input type="number" class="form-control" id="max_file_size_mb" name="max_file_size_mb" min="1" max="100">
                                                    <div class="form-text">Maximum file upload size</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="log_level" class="form-label">Log Level</label>
                                                    <select class="form-select" id="log_level" name="log_level">
                                                        <option value="DEBUG">DEBUG</option>
                                                        <option value="INFO">INFO</option>
                                                        <option value="WARNING">WARNING</option>
                                                        <option value="ERROR">ERROR</option>
                                                    </select>
                                                    <div class="form-text">Application logging verbosity</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="allowed_file_extensions" class="form-label">Allowed File Extensions</label>
                                            <input type="text" class="form-control" id="allowed_file_extensions" name="allowed_file_extensions">
                                            <div class="form-text">Comma-separated list of allowed file extensions</div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="enable_api_access" name="enable_api_access">
                                                    <label class="form-check-label" for="enable_api_access">
                                                        Enable API Access
                                                    </label>
                                                    <div class="form-text">Allow external API access</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="enable_file_logging" name="enable_file_logging">
                                                    <label class="form-check-label" for="enable_file_logging">
                                                        Enable File Logging
                                                    </label>
                                                    <div class="form-text">Save logs to files</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Advanced Panel -->
                                <div class="tab-pane fade" id="advanced-panel" role="tabpanel">
                                    <div class="feature-box mt-3">
                                        <h5 class="mb-4"><i class="fas fa-code me-2"></i>Advanced Settings</h5>

                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Warning:</strong> These settings can affect application performance and stability. Change with caution.
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" id="debug_mode" name="debug_mode">
                                                    <label class="form-check-label" for="debug_mode">
                                                        Debug Mode
                                                    </label>
                                                    <div class="form-text">Enable detailed error logging</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" id="maintenance_mode" name="maintenance_mode">
                                                    <label class="form-check-label" for="maintenance_mode">
                                                        Maintenance Mode
                                                    </label>
                                                    <div class="form-text">Block normal user access</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" id="enable_cache" name="enable_cache">
                                                    <label class="form-check-label" for="enable_cache">
                                                        Enable Cache
                                                    </label>
                                                    <div class="form-text">Use application caching</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="cache_timeout_minutes" class="form-label">Cache Timeout (Minutes)</label>
                                                    <input type="number" class="form-control" id="cache_timeout_minutes" name="cache_timeout_minutes" min="1" max="1440">
                                                    <div class="form-text">Cache expiration time</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Configuration Section -->
                <div id="ai-config" class="content-section" style="display: none;">
                    <div class="mb-4">
                        <h2 class="mb-1"><i class="fas fa-robot me-2" style="color: var(--primary-color);"></i>AI Configuration</h2>
                        <p class="text-muted mb-0">Configure AI services, models, and integration settings</p>
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="feature-box">
                                <h5 class="mb-4"><i class="fas fa-cog me-2"></i>Langflow Integration Settings</h5>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="configLangflowUrl" class="form-label">Langflow Base URL</label>
                                            <input type="url" class="form-control" id="configLangflowUrl"
                                                   placeholder="http://localhost:7860"
                                                   value="http://10.88.4.25:7860">
                                            <div class="form-text">Base URL of your Langflow instance</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="configFlowId" class="form-label">Default Flow ID</label>
                                            <input type="text" class="form-control" id="configFlowId"
                                                   placeholder="your-flow-id"
                                                   value="900b0d89-4481-4f64-88bf-4d4661086a62">
                                            <div class="form-text">Default flow ID for AI conversations</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="configApiKey" class="form-label">API Key</label>
                                            <input type="password" class="form-control" id="configApiKey"
                                                   placeholder="Your Langflow API key">
                                            <div class="form-text">Optional API key for authenticated access</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="configDefaultModel" class="form-label">Default Model</label>
                                            <select class="form-control" id="configDefaultModel">
                                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                                <option value="gpt-4">GPT-4</option>
                                                <option value="claude-3">Claude 3</option>
                                                <option value="llama-2">Llama 2</option>
                                            </select>
                                            <div class="form-text">Default AI model for conversations</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="configTimeout" class="form-label">Request Timeout (seconds)</label>
                                            <input type="number" class="form-control" id="configTimeout"
                                                   value="30" min="5" max="300">
                                            <div class="form-text">Timeout for AI API requests</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="configMaxRetries" class="form-label">Max Retries</label>
                                            <input type="number" class="form-control" id="configMaxRetries"
                                                   value="3" min="1" max="10">
                                            <div class="form-text">Maximum retry attempts for failed requests</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex gap-3">
                                    <button class="btn btn-primary" onclick="saveAIConfig()">
                                        <i class="fas fa-save me-1"></i>
                                        Save Configuration
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="testAIConnection()">
                                        <i class="fas fa-plug me-1"></i>
                                        Test Connection
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="resetAIConfig()">
                                        <i class="fas fa-undo me-1"></i>
                                        Reset to Defaults
                                    </button>
                                </div>

                                <div id="aiConfigResult" class="mt-3"></div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="feature-box">
                                <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Configuration Tips</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Use HTTPS URLs for production environments
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Test connection after changing settings
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check text-success me-2"></i>
                                        API keys are stored securely in browser storage
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Timeout values depend on your network speed
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- File Upload Configuration Section -->
                <div id="file-config" class="content-section" style="display: none;">
                    <div class="mb-4">
                        <h2 class="mb-1"><i class="fas fa-file-cog me-2" style="color: var(--primary-color);"></i>File Upload Configuration</h2>
                        <p class="text-muted mb-0">Configure file upload settings, size limits, and processing options</p>
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="feature-box">
                                <h5 class="mb-4"><i class="fas fa-upload me-2"></i>Upload Settings</h5>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="configMaxFileSize" class="form-label">Max File Size (MB)</label>
                                            <input type="number" class="form-control" id="configMaxFileSize"
                                                   value="10" min="1" max="100">
                                            <div class="form-text">Maximum file size for uploads</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="configMaxFiles" class="form-label">Max Files per Upload</label>
                                            <input type="number" class="form-control" id="configMaxFiles"
                                                   value="5" min="1" max="20">
                                            <div class="form-text">Maximum number of files in one upload</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="configAllowedTypes" class="form-label">Allowed File Types</label>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="allowTxt" checked>
                                                <label class="form-check-label" for="allowTxt">Text files (.txt)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="allowPdf" checked>
                                                <label class="form-check-label" for="allowPdf">PDF files (.pdf)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="allowDoc" checked>
                                                <label class="form-check-label" for="allowDoc">Word docs (.doc, .docx)</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="allowCsv" checked>
                                                <label class="form-check-label" for="allowCsv">CSV files (.csv)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="allowJson" checked>
                                                <label class="form-check-label" for="allowJson">JSON files (.json)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="allowMd" checked>
                                                <label class="form-check-label" for="allowMd">Markdown (.md)</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="allowXls">
                                                <label class="form-check-label" for="allowXls">Excel files (.xls, .xlsx)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="allowImages">
                                                <label class="form-check-label" for="allowImages">Images (.jpg, .png, .gif)</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="configUploadEndpoint" class="form-label">AI Chat Upload Endpoint</label>
                                            <select class="form-control" id="configUploadEndpoint">
                                                <option value="/api/v2/files/">/api/v2/files/ (Langflow v2)</option>
                                                <option value="/api/v1/files/">/api/v1/files/ (Langflow v1)</option>
                                                <option value="/files/">/files/ (Generic)</option>
                                                <option value="/upload">/upload (Simple)</option>
                                            </select>
                                            <div class="form-text">Primary endpoint for AI chat file uploads</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="configUploadTimeout" class="form-label">Upload Timeout (seconds)</label>
                                            <input type="number" class="form-control" id="configUploadTimeout"
                                                   value="60" min="10" max="300">
                                            <div class="form-text">Timeout for file upload requests</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="configFallbackEnabled" checked>
                                    <label class="form-check-label" for="configFallbackEnabled">
                                        Enable fallback to text content for failed uploads
                                    </label>
                                    <div class="form-text">If file upload fails, include text content in message instead</div>
                                </div>

                                <!-- Langflow Destination Path Section -->
                                <div class="mb-4 mt-4">
                                    <h6 class="mb-3"><i class="fas fa-route me-2"></i>Langflow Destination Path</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="configDestinationComponent" class="form-label">Target Component ID</label>
                                                <input type="text" class="form-control" id="configDestinationComponent"
                                                       value="File-QW4Au" placeholder="File-QW4Au">
                                                <div class="form-text">Component ID that receives uploaded files</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="configDestinationInput" class="form-label">Input Field Name</label>
                                                <input type="text" class="form-control" id="configDestinationInput"
                                                       value="path" placeholder="path">
                                                <div class="form-text">Input field name for file path parameter</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label for="configDestinationPath" class="form-label">Full Destination Path</label>
                                                <input type="text" class="form-control" id="configDestinationPath"
                                                       value="File-QW4Au.path" placeholder="ComponentID.InputField">
                                                <div class="form-text">Complete path: ComponentID.InputFieldName (auto-generated from above)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex gap-3">
                                    <button class="btn btn-primary" onclick="saveFileConfig()">
                                        <i class="fas fa-save me-1"></i>
                                        Save Configuration
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="testFileUpload()">
                                        <i class="fas fa-upload me-1"></i>
                                        Test Upload
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="resetFileConfig()">
                                        <i class="fas fa-undo me-1"></i>
                                        Reset to Defaults
                                    </button>
                                </div>

                                <div id="fileConfigResult" class="mt-3"></div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="feature-box">
                                <h6 class="mb-3"><i class="fas fa-shield-alt me-2"></i>Security Settings</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-lock text-warning me-2"></i>
                                        Files are scanned for malware
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-lock text-warning me-2"></i>
                                        Size limits prevent abuse
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-lock text-warning me-2"></i>
                                        Type restrictions enforced
                                    </li>
                                </ul>

                                <h6 class="mb-3 mt-4"><i class="fas fa-chart-line me-2"></i>Upload Statistics</h6>
                                <div class="small">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Success Rate:</span>
                                        <span class="text-success">98.5%</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Avg Upload Time:</span>
                                        <span>2.3s</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Total Uploads:</span>
                                        <span>1,247</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WBS APP Section -->
                <div id="wbs-app" class="content-section" style="display: none;">
                    <div class="mb-4">
                        <h2 class="mb-1"><i class="fas fa-project-diagram me-2" style="color: var(--primary-color);"></i>WBS APP</h2>
                        <p class="text-muted mb-0">Work Breakdown Structure Application for project management</p>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="feature-box">
                                <h5 class="mb-4"><i class="fas fa-rocket me-2"></i>Coming Soon</h5>

                                <div class="text-center py-5">
                                    <div class="d-flex align-items-center justify-content-center mb-4"
                                         style="width: 80px; height: 80px; background: rgba(37, 99, 235, 0.1); border-radius: var(--border-radius); margin: 0 auto;">
                                        <i class="fas fa-project-diagram fs-1" style="color: var(--primary-color);"></i>
                                    </div>
                                    <h4 class="mb-3">WBS Application</h4>
                                    <p class="text-muted mb-4">A comprehensive Work Breakdown Structure tool for project planning and management is in development.</p>

                                    <div class="row justify-content-center">
                                        <div class="col-md-8">
                                            <div class="alert alert-info">
                                                <h6><i class="fas fa-info-circle me-2"></i>Planned Features</h6>
                                                <ul class="list-unstyled mb-0">
                                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Interactive WBS tree visualization</li>
                                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Drag-and-drop task organization</li>
                                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Resource allocation and tracking</li>
                                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Export to multiple formats</li>
                                                    <li class="mb-0"><i class="fas fa-check text-success me-2"></i>Integration with project management tools</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RFPO Application Section -->
                <div id="rfpo-app" class="content-section" style="display: none;">
                    <div class="mb-4">
                        <h2 class="mb-1"><i class="fas fa-clipboard-list me-2" style="color: var(--primary-color);"></i>RFPO</h2>
                        <p class="text-muted mb-0">Request for Purchase Order Operations - Comprehensive RFPO management system</p>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="feature-box">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="mb-0"><i class="fas fa-file-contract me-2"></i>RFPO Management Dashboard</h5>
                                    <div>
                                        <button class="btn btn-primary btn-sm me-2" onclick="createNewRFPO()">
                                            <i class="fas fa-plus me-1"></i>
                                            New RFPO
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="importRFPOTemplate()">
                                            <i class="fas fa-upload me-1"></i>
                                            Import Template
                                        </button>
                                    </div>
                                </div>

                                <!-- RFPO Statistics Row -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="stat-card text-center">
                                            <div class="stat-icon mb-2">
                                                <i class="fas fa-file-alt" style="color: var(--primary-color);"></i>
                                            </div>
                                            <h6 class="mb-1">Total RFPOs</h6>
                                            <h4 class="mb-0" id="rfpo-total-count">12</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card text-center">
                                            <div class="stat-icon mb-2">
                                                <i class="fas fa-clock" style="color: var(--warning-color);"></i>
                                            </div>
                                            <h6 class="mb-1">In Progress</h6>
                                            <h4 class="mb-0" id="rfpo-progress-count">5</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card text-center">
                                            <div class="stat-icon mb-2">
                                                <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                                            </div>
                                            <h6 class="mb-1">Completed</h6>
                                            <h4 class="mb-0" id="rfpo-completed-count">7</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card text-center">
                                            <div class="stat-icon mb-2">
                                                <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
                                            </div>
                                            <h6 class="mb-1">Overdue</h6>
                                            <h4 class="mb-0" id="rfpo-overdue-count">2</h4>
                                        </div>
                                    </div>
                                </div>

                                <!-- RFPO List Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-hashtag me-1"></i>ID</th>
                                                <th><i class="fas fa-file-contract me-1"></i>RFPO Title</th>
                                                <th><i class="fas fa-building me-1"></i>Client</th>
                                                <th><i class="fas fa-calendar me-1"></i>Due Date</th>
                                                <th><i class="fas fa-info-circle me-1"></i>Status</th>
                                                <th><i class="fas fa-user me-1"></i>Assigned To</th>
                                                <th><i class="fas fa-cogs me-1"></i>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="rfpo-table-body">
                                            <tr>
                                                <td><span class="badge bg-primary">RFPO-001</span></td>
                                                <td>IT Infrastructure Modernization</td>
                                                <td>ACME Corporation</td>
                                                <td>2025-09-15</td>
                                                <td><span class="badge bg-warning">In Progress</span></td>
                                                <td>John Smith</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editRFPO('RFPO-001')">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-success me-1" onclick="viewRFPO('RFPO-001')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRFPO('RFPO-001')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><span class="badge bg-primary">RFPO-002</span></td>
                                                <td>Cloud Migration Services</td>
                                                <td>Tech Solutions Inc</td>
                                                <td>2025-08-30</td>
                                                <td><span class="badge bg-danger">Overdue</span></td>
                                                <td>Sarah Johnson</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editRFPO('RFPO-002')">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-success me-1" onclick="viewRFPO('RFPO-002')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRFPO('RFPO-002')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><span class="badge bg-primary">RFPO-003</span></td>
                                                <td>Security Assessment & Consulting</td>
                                                <td>SecureNet Ltd</td>
                                                <td>2025-10-01</td>
                                                <td><span class="badge bg-success">Completed</span></td>
                                                <td>Mike Davis</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editRFPO('RFPO-003')">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-success me-1" onclick="viewRFPO('RFPO-003')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info" onclick="downloadRFPO('RFPO-003')">
                                                        <i class="fas fa-download"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- RFPO Templates and Quick Actions -->
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card border-0 h-100" style="background: rgba(37, 99, 235, 0.05);">
                                            <div class="card-body">
                                                <h6 class="card-title"><i class="fas fa-file-alt me-2"></i>RFPO Templates</h6>
                                                <p class="card-text text-muted mb-3">Use predefined templates to quickly create new RFPOs</p>
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('it-services')">
                                                        <i class="fas fa-server me-1"></i>IT Services Template
                                                    </button>
                                                    <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('consulting')">
                                                        <i class="fas fa-handshake me-1"></i>Consulting Template
                                                    </button>
                                                    <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('software')">
                                                        <i class="fas fa-code me-1"></i>Software Development Template
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card border-0 h-100" style="background: rgba(16, 185, 129, 0.05);">
                                            <div class="card-body">
                                                <h6 class="card-title"><i class="fas fa-chart-line me-2"></i>Analytics & Reports</h6>
                                                <p class="card-text text-muted mb-3">Generate insights and reports on RFPO performance</p>
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-outline-success btn-sm" onclick="generateReport('summary')">
                                                        <i class="fas fa-chart-bar me-1"></i>Summary Report
                                                    </button>
                                                    <button class="btn btn-outline-success btn-sm" onclick="generateReport('timeline')">
                                                        <i class="fas fa-calendar-alt me-1"></i>Timeline Analysis
                                                    </button>
                                                    <button class="btn btn-outline-success btn-sm" onclick="generateReport('vendor')">
                                                        <i class="fas fa-users me-1"></i>Vendor Performance
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Editor Section -->
                <div id="nav-editor" class="content-section" style="display: none;">
                    <div class="mb-4">
                        <h2 class="mb-1"><i class="fas fa-edit me-2" style="color: var(--primary-color);"></i>Navigation Editor</h2>
                        <p class="text-muted mb-0">Customize and manage the application navigation menu</p>
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="feature-box">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="mb-0"><i class="fas fa-bars me-2"></i>Navigation Items</h5>
                                    <button class="btn btn-success btn-sm" onclick="addCustomMenuItem()">
                                        <i class="fas fa-plus me-1"></i>
                                        Add Menu Item
                                    </button>
                                </div>

                                <!-- Navigation Editor Interface -->
                                <div id="navigationEditor" class="navigation-editor">
                                    <div class="editor-toolbar mb-3">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="expandAllMenus()" title="Expand All">
                                                <i class="fas fa-expand-alt"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="collapseAllMenus()" title="Collapse All">
                                                <i class="fas fa-compress-alt"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="previewNavigation()" title="Preview Changes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="ms-3 small text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Drag items to reorder â¢ Click to edit â¢ Toggle visibility
                                        </div>
                                    </div>

                                    <div id="menuItemsList" class="menu-items-list">
                                        <!-- Menu items will be loaded here dynamically -->
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <div class="d-flex gap-3">
                                        <button class="btn btn-primary" onclick="saveNavigationConfig()">
                                            <i class="fas fa-save me-1"></i>
                                            Save Navigation
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="resetNavigationToDefault()">
                                            <i class="fas fa-undo me-1"></i>
                                            Reset to Default
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="exportNavigationConfig()">
                                            <i class="fas fa-download me-1"></i>
                                            Export Config
                                        </button>
                                    </div>
                                </div>

                                <div id="navEditorResult" class="mt-3"></div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="feature-box mb-3">
                                <h6 class="mb-3"><i class="fas fa-cog me-2"></i>Role-Based Visibility</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableRoleBasedNav" onchange="toggleRoleBasedNavigation()">
                                    <label class="form-check-label" for="enableRoleBasedNav">
                                        Enable role-based menu visibility
                                    </label>
                                </div>
                                <div class="mt-3" id="roleSettings" style="display: none;">
                                    <label class="form-label small">Available Roles:</label>
                                    <div class="role-badges">
                                        <span class="badge bg-primary role-badge" data-role="admin">Admin</span>
                                        <span class="badge bg-secondary role-badge" data-role="user">User</span>
                                        <span class="badge bg-success role-badge" data-role="guest">Guest</span>
                                    </div>
                                </div>
                            </div>

                            <div class="feature-box">
                                <h6 class="mb-3"><i class="fas fa-lightbulb me-2"></i>Editor Features</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-arrows-alt text-info me-2"></i>
                                        Drag & drop menu reordering
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-plus text-success me-2"></i>
                                        Add custom menu items
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-edit text-warning me-2"></i>
                                        Edit menu labels and icons
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-eye-slash text-secondary me-2"></i>
                                        Hide/show menu items
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-users-cog text-primary me-2"></i>
                                        Role-based menu visibility
                                    </li>
                                </ul>

                                <div class="alert alert-info mt-4">
                                    <small><i class="fas fa-info-circle me-1"></i>
                                    <strong>Tip:</strong> Changes are saved to browser storage and will persist across sessions.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Menu Item Modal -->
                    <div class="modal fade" id="editMenuModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Edit Menu Item</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editMenuForm">
                                        <input type="hidden" id="editMenuId">
                                        <div class="mb-3">
                                            <label for="editMenuLabel" class="form-label">Label</label>
                                            <input type="text" class="form-control" id="editMenuLabel" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editMenuIcon" class="form-label">Icon (FontAwesome class)</label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i id="editMenuIconPreview" class="fas fa-cog"></i></span>
                                                <input type="text" class="form-control" id="editMenuIcon" placeholder="fas fa-cog" oninput="updateIconPreview()">
                                            </div>
                                            <div class="form-text">
                                                Common icons: fas fa-home, fas fa-users, fas fa-cog, fas fa-chart-bar, fas fa-file
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editMenuAction" class="form-label">Action</label>
                                            <select class="form-control" id="editMenuAction">
                                                <option value="section">Show Section</option>
                                                <option value="url">Open URL</option>
                                                <option value="function">Call Function</option>
                                                <option value="submenu">Submenu Parent</option>
                                            </select>
                                        </div>
                                        <div class="mb-3" id="editMenuTargetContainer">
                                            <label for="editMenuTarget" class="form-label">Target</label>
                                            <input type="text" class="form-control" id="editMenuTarget" placeholder="dashboard">
                                            <div class="form-text">Section ID, URL, or function name</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Role Visibility</label>
                                            <div class="role-checkboxes">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="editRoleGuest" value="guest">
                                                    <label class="form-check-label" for="editRoleGuest">Guest</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="editRoleUser" value="user">
                                                    <label class="form-check-label" for="editRoleUser">User</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="editRoleAdmin" value="admin">
                                                    <label class="form-check-label" for="editRoleAdmin">Admin</label>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="saveMenuItemEdit()">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Simple function to open chat section
        function openChatSection() {
            try {
                console.log('Opening chat section...');

                // Hide all sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                });

                // Remove active class from all nav links
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });

                // Show chat section
                const chatSection = document.getElementById('chat');
                if (chatSection) {
                    chatSection.style.display = 'block';
                    console.log('Chat section displayed');
                } else {
                    console.error('Chat section not found');
                    return false;
                }

                // Add active class to current link
                if (typeof event !== 'undefined' && event && event.target) {
                    event.target.classList.add('active');
                }

                // Close mobile sidebar if function exists
                if (typeof closeMobileSidebar === 'function') {
                    closeMobileSidebar();
                }

                // Initialize chat if needed
                if (typeof updateWelcomeTime === 'function') {
                    updateWelcomeTime();
                }
                if (typeof updateModelBadge === 'function') {
                    updateModelBadge();
                }

                return false;
            } catch (error) {
                console.error('Error in openChatSection:', error);
                return false;
            }
        }
        function showSection(sectionId) {
            try {
                console.log('showSection called with:', sectionId);

                // Validate input
                if (!sectionId || typeof sectionId !== 'string') {
                    console.error('Invalid section ID provided:', sectionId);
                    return false;
                }

                // Hide all sections
                const sections = document.querySelectorAll('.content-section');
                console.log('Found sections:', sections.length);
                if (sections.length === 0) {
                    console.error('No content sections found!');
                    return false;
                }

                sections.forEach(section => {
                    section.style.display = 'none';
                });

                // Remove active class from all nav links and sublinks
                const navLinks = document.querySelectorAll('.nav-link');
                const navSublinks = document.querySelectorAll('.nav-sublink');
                console.log('Found nav links:', navLinks.length, 'sublinks:', navSublinks.length);
                navLinks.forEach(link => {
                    link.classList.remove('active');
                });
                navSublinks.forEach(link => {
                    link.classList.remove('active');
                });

                // Show selected section
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    console.log('Section displayed successfully:', sectionId);
                } else {
                    console.error('Section not found:', sectionId);
                    console.log('Available sections:', Array.from(sections).map(s => s.id));
                    return false;
                }

                // Add active class to clicked nav link or sublink
                if (typeof event !== 'undefined' && event && event.target) {
                    if (event.target.classList.contains('nav-sublink')) {
                        event.target.classList.add('active');
                    } else {
                        event.target.classList.add('active');
                    }
                    console.log('Active class added to nav link');
                } else {
                    // Fallback: find the nav link for this section
                    const navLink = document.querySelector(`[onclick*="showSection('${sectionId}')"]`);
                    if (navLink) {
                        navLink.classList.add('active');
                        console.log('Active class added to nav link (fallback)');
                    }
                }

                // Close mobile sidebar if open
                if (typeof closeMobileSidebar === 'function') {
                    closeMobileSidebar();
                }

                // Special handling for user management section
                if (sectionId === 'users') {
                    if (typeof checkAuthForUserMgmt === 'function') {
                        checkAuthForUserMgmt();
                    }
                }

                // Special handling for chat section
                if (sectionId === 'chat') {
                    console.log('Chat section opened, initializing...');
                    // Initialize chat if needed
                    if (typeof updateWelcomeTime === 'function') {
                        updateWelcomeTime();
                    }
                    if (typeof updateModelBadge === 'function') {
                        updateModelBadge();
                    }
                }

                // Special handling for configuration sections
                if (sectionId === 'ai-config' || sectionId === 'file-config' || sectionId === 'app-settings') {
                    console.log('Configuration section opened, loading saved settings...');
                    // Expand the configuration menu if not already expanded
                    const configParent = document.getElementById('configNavParent');
                    if (configParent && !configParent.classList.contains('expanded')) {
                        configParent.classList.add('expanded');
                    }
                    // Load saved configurations
                    if (typeof loadSavedConfigurations === 'function') {
                        loadSavedConfigurations();
                    }
                    // Load application settings if viewing app-settings
                    if (sectionId === 'app-settings' && typeof loadApplicationSettings === 'function') {
                        loadApplicationSettings();
                    }
                }

                return false;

            } catch (error) {
                console.error('Error in showSection:', error);
                alert('Error opening section: ' + error.message);
                return false;
            }
        }

        // Mobile sidebar functions
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (sidebar.classList.contains('show')) {
                closeMobileSidebar();
            } else {
                sidebar.classList.add('show');
                overlay.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.remove('show');
            overlay.style.display = 'none';
            document.body.style.overflow = '';
        }

        // Close sidebar when clicking on nav links on mobile
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    setTimeout(closeMobileSidebar, 100);
                }
            });
        });

        // Test API functionality
        function testAPI() {
            alert('API Test:\n\nâ Server: Online\nâ Authentication: Ready\nâ File Upload: Ready\nâ User Management: Ready\n\nAll API endpoints are functioning properly!');
        }

        // Configuration Menu Functions
        function toggleConfigMenu() {
            const parent = document.getElementById('configNavParent');
            const isExpanded = parent.classList.contains('expanded');

            if (isExpanded) {
                parent.classList.remove('expanded');
            } else {
                parent.classList.add('expanded');
            }

            return false;
        }

        // Applications Menu Functions
        function toggleAppsMenu() {
            console.log('toggleAppsMenu called');
            const parent = document.getElementById('appsNavParent');
            console.log('Found parent element:', parent);
            const isExpanded = parent.classList.contains('expanded');
            console.log('Is currently expanded:', isExpanded);

            if (isExpanded) {
                parent.classList.remove('expanded');
                console.log('Removed expanded class');
            } else {
                parent.classList.add('expanded');
                console.log('Added expanded class');
            }

            return false;
        }

        // AI Configuration Functions
        function saveAIConfig() {
            const config = {
                langflowUrl: document.getElementById('configLangflowUrl').value,
                flowId: document.getElementById('configFlowId').value,
                apiKey: document.getElementById('configApiKey').value,
                defaultModel: document.getElementById('configDefaultModel').value,
                timeout: document.getElementById('configTimeout').value,
                maxRetries: document.getElementById('configMaxRetries').value
            };

            // Save to localStorage
            localStorage.setItem('aiConfig', JSON.stringify(config));

            // Also save individual values for easy access by chat functions
            localStorage.setItem('aiConfig_langflowUrl', config.langflowUrl);
            localStorage.setItem('aiConfig_flowId', config.flowId);
            localStorage.setItem('aiConfig_apiKey', config.apiKey);
            localStorage.setItem('aiConfig_defaultModel', config.defaultModel);

            document.getElementById('aiConfigResult').innerHTML =
                '<div class="alert alert-success"><i class="fas fa-check me-2"></i>AI configuration saved successfully!</div>';

            console.log('AI Configuration saved:', config);
        }

        function testAIConnection() {
            const langflowUrl = document.getElementById('configLangflowUrl').value;
            const flowId = document.getElementById('configFlowId').value;
            const resultDiv = document.getElementById('aiConfigResult');

            if (!langflowUrl) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a Langflow URL first.</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Testing connection...</div>';

            // Test the actual flow endpoint that will be used
            async function testConnection() {
                try {
                    const url = new URL(langflowUrl);
                    const baseUrl = `${url.protocol}//${url.host}`;

                    let testResults = [];

                    // Test 1: Basic connectivity
                    try {
                        const healthResponse = await fetch(`${baseUrl}/health`, {
                            method: 'GET',
                            timeout: 5000
                        });
                        if (healthResponse.ok) {
                            testResults.push('â Health endpoint accessible');
                        } else {
                            testResults.push('â ï¸ Health endpoint returned error: ' + healthResponse.status);
                        }
                    } catch (healthError) {
                        testResults.push('â Health endpoint not accessible: ' + healthError.message);
                    }

                    // Test 2: Flow endpoint (if Flow ID provided)
                    if (flowId) {
                        try {
                            const flowEndpoint = `${baseUrl}/api/v1/run/${flowId}`;
                            const flowResponse = await fetch(flowEndpoint, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                body: JSON.stringify({
                                    input_value: "test",
                                    output_type: "chat",
                                    input_type: "chat"
                                })
                            });

                            const responseText = await flowResponse.text();

                            if (flowResponse.ok) {
                                try {
                                    JSON.parse(responseText);
                                    testResults.push('â Flow endpoint accessible and returns valid JSON');
                                } catch (parseError) {
                                    testResults.push('â ï¸ Flow endpoint accessible but returned invalid JSON');
                                }
                            } else {
                                if (responseText.trim().startsWith('<')) {
                                    testResults.push('â Flow endpoint returned HTML (likely 404 - check Flow ID)');
                                } else {
                                    testResults.push(`â Flow endpoint error: ${flowResponse.status} - ${responseText.substring(0, 100)}`);
                                }
                            }
                        } catch (flowError) {
                            testResults.push('â Flow endpoint test failed: ' + flowError.message);
                        }
                    } else {
                        testResults.push('â ï¸ No Flow ID provided - cannot test flow endpoint');
                    }

                    // Test 3: File upload endpoints
                    const fileEndpoints = [
                        `${baseUrl}/api/v2/files/`,
                        `${baseUrl}/api/v1/files/`
                    ];

                    for (const endpoint of fileEndpoints) {
                        try {
                            const fileResponse = await fetch(endpoint, {
                                method: 'OPTIONS'  // Just check if endpoint exists
                            });
                            if (fileResponse.ok || fileResponse.status === 405) {
                                testResults.push(`â File endpoint accessible: ${endpoint}`);
                            } else {
                                testResults.push(`â ï¸ File endpoint issue: ${endpoint} (${fileResponse.status})`);
                            }
                        } catch (fileError) {
                            testResults.push(`â File endpoint not accessible: ${endpoint}`);
                        }
                    }

                    // Display results
                    const resultHtml = `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Connection Test Results</h6>
                            <ul class="mb-0">
                                ${testResults.map(result => `<li>${result}</li>`).join('')}
                            </ul>
                            <hr>
                            <strong>Base URL:</strong> ${baseUrl}<br>
                            <strong>Flow Endpoint:</strong> ${baseUrl}/api/v1/run/${flowId || '[not-set]'}
                        </div>
                    `;

                    resultDiv.innerHTML = resultHtml;

                } catch (error) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Connection Test Failed</h6>
                            <p>Error: ${error.message}</p>
                            <p><strong>Check:</strong></p>
                            <ul>
                                <li>URL format is correct</li>
                                <li>Langflow server is running</li>
                                <li>No firewall blocking access</li>
                                <li>CORS is properly configured</li>
                            </ul>
                        </div>
                    `;
                }
            }

            testConnection();
        }

        function resetAIConfig() {
            document.getElementById('configLangflowUrl').value = 'http://10.88.4.25:7860';
            document.getElementById('configFlowId').value = '900b0d89-4481-4f64-88bf-4d4661086a62';
            document.getElementById('configApiKey').value = '';
            document.getElementById('configDefaultModel').value = 'gpt-3.5-turbo';
            document.getElementById('configTimeout').value = '30';
            document.getElementById('configMaxRetries').value = '3';

            document.getElementById('aiConfigResult').innerHTML =
                '<div class="alert alert-info"><i class="fas fa-info me-2"></i>Configuration reset to defaults.</div>';
        }

        // File Configuration Functions
        function saveFileConfig() {
            const config = {
                maxFileSize: document.getElementById('configMaxFileSize').value,
                maxFiles: document.getElementById('configMaxFiles').value,
                allowedTypes: {
                    txt: document.getElementById('allowTxt').checked,
                    pdf: document.getElementById('allowPdf').checked,
                    doc: document.getElementById('allowDoc').checked,
                    csv: document.getElementById('allowCsv').checked,
                    json: document.getElementById('allowJson').checked,
                    md: document.getElementById('allowMd').checked,
                    xls: document.getElementById('allowXls').checked,
                    images: document.getElementById('allowImages').checked
                },
                uploadEndpoint: document.getElementById('configUploadEndpoint').value,
                uploadTimeout: document.getElementById('configUploadTimeout').value,
                fallbackEnabled: document.getElementById('configFallbackEnabled').checked,
                // Langflow destination path settings
                destinationComponent: document.getElementById('configDestinationComponent').value,
                destinationInput: document.getElementById('configDestinationInput').value,
                destinationPath: document.getElementById('configDestinationPath').value
            };

            // Save to localStorage
            localStorage.setItem('fileConfig', JSON.stringify(config));

            // Apply changes immediately
            applyFileConfigChanges(config);

            document.getElementById('fileConfigResult').innerHTML =
                '<div class="alert alert-success"><i class="fas fa-check me-2"></i>File upload configuration saved and applied successfully!</div>';

            console.log('File Configuration saved and applied:', config);
        }

        function applyFileConfigChanges(config) {
            // Update file input accept attributes
            updateFileInputAcceptTypes(config.allowedTypes);

            // Update file upload section descriptions
            updateFileUploadDescriptions(config);

            // Update chat file input
            updateChatFileInput(config.allowedTypes);

            console.log('File configuration changes applied successfully');
        }

        function updateFileInputAcceptTypes(allowedTypes) {
            let acceptString = '';
            let extensions = [];

            if (allowedTypes.txt) {
                extensions.push('.txt');
            }
            if (allowedTypes.pdf) {
                extensions.push('.pdf');
            }
            if (allowedTypes.doc) {
                extensions.push('.doc', '.docx');
            }
            if (allowedTypes.csv) {
                extensions.push('.csv');
            }
            if (allowedTypes.json) {
                extensions.push('.json');
            }
            if (allowedTypes.md) {
                extensions.push('.md');
            }
            if (allowedTypes.xls) {
                extensions.push('.xls', '.xlsx');
            }
            if (allowedTypes.images) {
                extensions.push('.jpg', '.jpeg', '.png', '.gif');
            }

            acceptString = extensions.join(',');

            // Update main file upload input
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.setAttribute('accept', acceptString);
            }

            // Update chat file input
            const chatFileInput = document.getElementById('chatFileInput');
            if (chatFileInput) {
                chatFileInput.setAttribute('accept', acceptString);
            }

            console.log('File input accept types updated:', acceptString);
        }

        function updateFileUploadDescriptions(config) {
            // Update the file upload section descriptions
            const uploadSection = document.querySelector('#upload .feature-box');
            if (uploadSection) {
                const supportedFormatsSection = uploadSection.querySelector('h6');
                if (supportedFormatsSection && supportedFormatsSection.textContent === 'Supported Formats:') {
                    const formatsList = supportedFormatsSection.nextElementSibling;
                    if (formatsList && formatsList.tagName === 'UL') {
                        formatsList.innerHTML = generateSupportedFormatsList(config.allowedTypes);
                    }
                }
            }
        }

        function generateSupportedFormatsList(allowedTypes) {
            let formats = [];

            if (allowedTypes.txt) formats.push('<li>Text files (.txt)</li>');
            if (allowedTypes.pdf) formats.push('<li>PDF files (.pdf)</li>');
            if (allowedTypes.doc) formats.push('<li>Word documents (.doc, .docx)</li>');
            if (allowedTypes.csv) formats.push('<li>CSV files (.csv)</li>');
            if (allowedTypes.json) formats.push('<li>JSON files (.json)</li>');
            if (allowedTypes.md) formats.push('<li>Markdown files (.md)</li>');
            if (allowedTypes.xls) formats.push('<li>Excel files (.xls, .xlsx)</li>');
            if (allowedTypes.images) formats.push('<li>Image files (.jpg, .png, .gif)</li>');

            return formats.length > 0 ? formats.join('') : '<li>No file types enabled</li>';
        }

        function updateChatFileInput(allowedTypes) {
            // Update the file upload button title/tooltip
            const uploadButton = document.querySelector('[onclick*="chatFileInput"]');
            if (uploadButton) {
                let supportedTypes = [];
                if (allowedTypes.txt) supportedTypes.push('txt');
                if (allowedTypes.pdf) supportedTypes.push('pdf');
                if (allowedTypes.doc) supportedTypes.push('doc');
                if (allowedTypes.csv) supportedTypes.push('csv');
                if (allowedTypes.json) supportedTypes.push('json');
                if (allowedTypes.md) supportedTypes.push('md');
                if (allowedTypes.xls) supportedTypes.push('xls');
                if (allowedTypes.images) supportedTypes.push('images');

                const tooltip = supportedTypes.length > 0 ?
                    `Attach files (${supportedTypes.join(', ')})` :
                    'File uploads disabled';

                uploadButton.setAttribute('title', tooltip);
            }
        }

        function testFileUpload() {
            const resultDiv = document.getElementById('fileConfigResult');
            resultDiv.innerHTML =
                '<div class="alert alert-info"><i class="fas fa-info me-2"></i>File upload test completed. Check browser console for detailed endpoint testing.</div>';

            console.log('File upload configuration test - settings would be applied to actual uploads.');
        }

        function resetFileConfig() {
            document.getElementById('configMaxFileSize').value = '10';
            document.getElementById('configMaxFiles').value = '5';
            document.getElementById('allowTxt').checked = true;
            document.getElementById('allowPdf').checked = true;
            document.getElementById('allowDoc').checked = true;
            document.getElementById('allowCsv').checked = true;
            document.getElementById('allowJson').checked = true;
            document.getElementById('allowMd').checked = true;
            document.getElementById('allowXls').checked = false;
            document.getElementById('allowImages').checked = false;
            document.getElementById('configUploadEndpoint').value = '/api/v2/files/';
            document.getElementById('configUploadTimeout').value = '60';
            document.getElementById('configFallbackEnabled').checked = true;

            // Apply the reset configuration immediately
            const defaultConfig = {
                maxFileSize: '10',
                maxFiles: '5',
                allowedTypes: {
                    txt: true,
                    pdf: true,
                    doc: true,
                    csv: true,
                    json: true,
                    md: true,
                    xls: false,
                    images: false
                },
                uploadEndpoint: '/api/v2/files/',
                uploadTimeout: '60',
                fallbackEnabled: true
            };

            // Save and apply changes
            localStorage.setItem('fileConfig', JSON.stringify(defaultConfig));
            applyFileConfigChanges(defaultConfig);

            document.getElementById('fileConfigResult').innerHTML =
                '<div class="alert alert-info"><i class="fas fa-info me-2"></i>File configuration reset to defaults and applied.</div>';
        }

        // Navigation Editor Functions
        let navigationConfig = {
            items: [],
            roleBasedVisibility: false
        };

        let draggedElement = null;
        let currentEditingItem = null;

        function initializeNavigationEditor() {
            console.log('Initializing Navigation Editor...');

            // Load existing navigation configuration
            loadNavigationConfig();

            // Render the navigation editor
            renderNavigationEditor();

            // Load role-based settings
            loadRoleBasedSettings();
        }

        function getDefaultNavigationConfig() {
            return {
                roleBasedVisibility: false,
                items: [
                    {
                        id: 'dashboard',
                        label: 'Dashboard',
                        icon: 'fas fa-tachometer-alt',
                        action: 'section',
                        target: 'dashboard',
                        visible: true,
                        roles: ['guest', 'user', 'admin'],
                        order: 1
                    },
                    {
                        id: 'auth',
                        label: 'Authentication',
                        icon: 'fas fa-sign-in-alt',
                        action: 'section',
                        target: 'auth',
                        visible: true,
                        roles: ['guest', 'user', 'admin'],
                        order: 2
                    },
                    {
                        id: 'upload',
                        label: 'File Upload',
                        icon: 'fas fa-file-upload',
                        action: 'section',
                        target: 'upload',
                        visible: true,
                        roles: ['user', 'admin'],
                        order: 3
                    },
                    {
                        id: 'users',
                        label: 'User Management',
                        icon: 'fas fa-users',
                        action: 'section',
                        target: 'users',
                        visible: true,
                        roles: ['admin'],
                        order: 4
                    },
                    {
                        id: 'chat',
                        label: 'AI Assistant',
                        icon: 'fas fa-comments',
                        action: 'function',
                        target: 'openChatSection',
                        visible: true,
                        roles: ['user', 'admin'],
                        order: 5
                    },
                    {
                        id: 'applications',
                        label: 'Applications',
                        icon: 'fas fa-th-large',
                        action: 'submenu',
                        target: '',
                        visible: true,
                        roles: ['user', 'admin'],
                        order: 6,
                        submenu: [
                            {
                                id: 'wbs-app',
                                label: 'WBS APP',
                                icon: 'fas fa-project-diagram',
                                action: 'section',
                                target: 'wbs-app',
                                visible: true,
                                roles: ['user', 'admin']
                            },
                            {
                                id: 'rfpo-app',
                                label: 'RFPO',
                                icon: 'fas fa-file-contract',
                                action: 'section',
                                target: 'rfpo-app',
                                visible: true,
                                roles: ['user', 'admin']
                            }
                        ]
                    },
                    {
                        id: 'configuration',
                        label: 'Configuration',
                        icon: 'fas fa-cog',
                        action: 'submenu',
                        target: '',
                        visible: true,
                        roles: ['admin'],
                        order: 7,
                        submenu: [
                            {
                                id: 'ai-config',
                                label: 'AI Configuration',
                                icon: 'fas fa-robot',
                                action: 'section',
                                target: 'ai-config',
                                visible: true,
                                roles: ['admin']
                            },
                            {
                                id: 'file-config',
                                label: 'File Upload Configuration',
                                icon: 'fas fa-cloud-upload-alt',
                                action: 'section',
                                target: 'file-config',
                                visible: true,
                                roles: ['admin']
                            },
                            {
                                id: 'nav-editor',
                                label: 'Navigation Editor',
                                icon: 'fas fa-edit',
                                action: 'section',
                                target: 'nav-editor',
                                visible: true,
                                roles: ['admin']
                            }
                        ]
                    },
                    {
                        id: 'test-api',
                        label: 'Test API',
                        icon: 'fas fa-flask',
                        action: 'function',
                        target: 'testAPI',
                        visible: true,
                        roles: ['admin'],
                        order: 8
                    }
                ]
            };
        }

        function loadNavigationConfig() {
            const saved = localStorage.getItem('navigationConfig');
            if (saved) {
                try {
                    navigationConfig = JSON.parse(saved);
                    console.log('Loaded navigation config:', navigationConfig);
                } catch (e) {
                    console.error('Error loading navigation config:', e);
                    navigationConfig = getDefaultNavigationConfig();
                }
            } else {
                navigationConfig = getDefaultNavigationConfig();
            }
        }

        function saveNavigationConfig() {
            try {
                localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));
                console.log('Navigation config saved:', navigationConfig);

                // Apply the changes to the actual navigation
                applyNavigationChanges();

                document.getElementById('navEditorResult').innerHTML =
                    '<div class="alert alert-success"><i class="fas fa-check me-2"></i>Navigation configuration saved successfully!</div>';

                setTimeout(() => {
                    document.getElementById('navEditorResult').innerHTML = '';
                }, 3000);
            } catch (e) {
                console.error('Error saving navigation config:', e);
                document.getElementById('navEditorResult').innerHTML =
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error saving navigation configuration.</div>';
            }
        }

        function resetNavigationToDefault() {
            if (confirm('Are you sure you want to reset the navigation to default settings? This will remove all custom menu items.')) {
                navigationConfig = getDefaultNavigationConfig();
                localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));
                renderNavigationEditor();
                loadRoleBasedSettings();

                document.getElementById('navEditorResult').innerHTML =
                    '<div class="alert alert-info"><i class="fas fa-info me-2"></i>Navigation reset to default configuration.</div>';

                setTimeout(() => {
                    document.getElementById('navEditorResult').innerHTML = '';
                }, 3000);
            }
        }

        function renderNavigationEditor() {
            const container = document.getElementById('menuItemsList');
            if (!container) return;

            container.innerHTML = '';

            // Sort items by order
            const sortedItems = [...navigationConfig.items].sort((a, b) => (a.order || 0) - (b.order || 0));

            sortedItems.forEach((item, index) => {
                const itemElement = createMenuItemElement(item, index);
                container.appendChild(itemElement);
            });

            // Initialize drag and drop
            initializeDragAndDrop();
        }

        function createMenuItemElement(item, index) {
            const div = document.createElement('div');
            div.className = `menu-item-editor ${!item.visible ? 'menu-item-hidden' : ''}`;
            div.draggable = true;
            div.dataset.itemId = item.id;
            div.dataset.index = index;

            const rolesText = item.roles ? item.roles.join(', ') : 'All roles';
            const actionText = item.action === 'section' ? 'Show Section' :
                             item.action === 'function' ? 'Call Function' :
                             item.action === 'url' ? 'Open URL' : 'Submenu';

            div.innerHTML = `
                <div class="menu-item-header">
                    <i class="fas fa-grip-vertical drag-handle"></i>
                    <i class="${item.icon} menu-item-icon"></i>
                    <span class="menu-item-label">${item.label}</span>
                    <div class="menu-item-controls">
                        <button class="menu-item-btn edit" onclick="editMenuItem('${item.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="menu-item-btn toggle" onclick="toggleMenuItemVisibility('${item.id}')" title="${item.visible ? 'Hide' : 'Show'}">
                            <i class="fas fa-${item.visible ? 'eye-slash' : 'eye'}"></i>
                        </button>
                        <button class="menu-item-btn delete" onclick="deleteMenuItem('${item.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="menu-item-meta">
                    <span class="meta-badge">${actionText}</span>
                    <span class="meta-badge roles">${rolesText}</span>
                    ${item.target ? `<span class="meta-badge">â ${item.target}</span>` : ''}
                </div>
            `;

            // Add submenu items if they exist
            if (item.submenu && item.submenu.length > 0) {
                const submenuContainer = document.createElement('div');
                submenuContainer.className = 'menu-item-submenu';

                item.submenu.forEach(subItem => {
                    const subElement = createSubmenuItemElement(subItem, item.id);
                    submenuContainer.appendChild(subElement);
                });

                div.appendChild(submenuContainer);
            }

            return div;
        }

        function createSubmenuItemElement(subItem, parentId) {
            const div = document.createElement('div');
            div.className = `menu-item-editor ${!subItem.visible ? 'menu-item-hidden' : ''}`;
            div.dataset.itemId = subItem.id;
            div.dataset.parentId = parentId;

            const rolesText = subItem.roles ? subItem.roles.join(', ') : 'All roles';
            const actionText = subItem.action === 'section' ? 'Show Section' :
                             subItem.action === 'function' ? 'Call Function' :
                             subItem.action === 'url' ? 'Open URL' : 'Action';

            div.innerHTML = `
                <div class="menu-item-header">
                    <i class="${subItem.icon} menu-item-icon"></i>
                    <span class="menu-item-label">${subItem.label}</span>
                    <div class="menu-item-controls">
                        <button class="menu-item-btn edit" onclick="editSubmenuItem('${parentId}', '${subItem.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="menu-item-btn toggle" onclick="toggleSubmenuItemVisibility('${parentId}', '${subItem.id}')" title="${subItem.visible ? 'Hide' : 'Show'}">
                            <i class="fas fa-${subItem.visible ? 'eye-slash' : 'eye'}"></i>
                        </button>
                        <button class="menu-item-btn delete" onclick="deleteSubmenuItem('${parentId}', '${subItem.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="menu-item-meta">
                    <span class="meta-badge">${actionText}</span>
                    <span class="meta-badge roles">${rolesText}</span>
                    ${subItem.target ? `<span class="meta-badge">â ${subItem.target}</span>` : ''}
                </div>
            `;

            return div;
        }

        function initializeDragAndDrop() {
            const items = document.querySelectorAll('.menu-item-editor[data-index]');

            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const draggedIndex = parseInt(draggedElement.dataset.index);
                const targetIndex = parseInt(this.dataset.index);

                // Reorder the items in the configuration
                const draggedItem = navigationConfig.items[draggedIndex];
                navigationConfig.items.splice(draggedIndex, 1);
                navigationConfig.items.splice(targetIndex, 0, draggedItem);

                // Update order numbers
                navigationConfig.items.forEach((item, index) => {
                    item.order = index + 1;
                });

                // Save to localStorage
                localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));

                // Re-render the editor
                renderNavigationEditor();
                applyNavigationChanges(); // Update live navigation

                console.log('Items reordered:', navigationConfig.items.map(i => i.label));
            }

            return false;
        }

        function handleDragEnd(e) {
            const items = document.querySelectorAll('.menu-item-editor');
            items.forEach(item => {
                item.classList.remove('drag-over', 'dragging');
            });
            draggedElement = null;
        }

        function addCustomMenuItem() {
            const newItem = {
                id: 'custom_' + Date.now(),
                label: 'New Menu Item',
                icon: 'fas fa-star',
                action: 'section',
                target: 'dashboard',
                visible: true,
                roles: ['user', 'admin'],
                order: navigationConfig.items.length + 1
            };

            navigationConfig.items.push(newItem);

            // Save to localStorage
            localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));

            renderNavigationEditor();
            applyNavigationChanges(); // Update live navigation

            // Automatically open edit modal for the new item
            setTimeout(() => {
                editMenuItem(newItem.id);
            }, 100);
        }

        function editMenuItem(itemId) {
            const item = navigationConfig.items.find(i => i.id === itemId);
            if (!item) return;

            currentEditingItem = { type: 'main', id: itemId };

            // Populate the modal
            document.getElementById('editMenuId').value = itemId;
            document.getElementById('editMenuLabel').value = item.label;
            document.getElementById('editMenuIcon').value = item.icon;
            document.getElementById('editMenuAction').value = item.action;
            document.getElementById('editMenuTarget').value = item.target || '';

            // Set role checkboxes
            document.getElementById('editRoleGuest').checked = item.roles.includes('guest');
            document.getElementById('editRoleUser').checked = item.roles.includes('user');
            document.getElementById('editRoleAdmin').checked = item.roles.includes('admin');

            updateIconPreview();

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editMenuModal'));
            modal.show();
        }

        function editSubmenuItem(parentId, itemId) {
            const parentItem = navigationConfig.items.find(i => i.id === parentId);
            if (!parentItem || !parentItem.submenu) return;

            const item = parentItem.submenu.find(i => i.id === itemId);
            if (!item) return;

            currentEditingItem = { type: 'submenu', parentId: parentId, id: itemId };

            // Populate the modal
            document.getElementById('editMenuId').value = itemId;
            document.getElementById('editMenuLabel').value = item.label;
            document.getElementById('editMenuIcon').value = item.icon;
            document.getElementById('editMenuAction').value = item.action;
            document.getElementById('editMenuTarget').value = item.target || '';

            // Set role checkboxes
            document.getElementById('editRoleGuest').checked = item.roles.includes('guest');
            document.getElementById('editRoleUser').checked = item.roles.includes('user');
            document.getElementById('editRoleAdmin').checked = item.roles.includes('admin');

            updateIconPreview();

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editMenuModal'));
            modal.show();
        }

        function saveMenuItemEdit() {
            if (!currentEditingItem) return;

            const label = document.getElementById('editMenuLabel').value;
            const icon = document.getElementById('editMenuIcon').value;
            const action = document.getElementById('editMenuAction').value;
            const target = document.getElementById('editMenuTarget').value;

            const roles = [];
            if (document.getElementById('editRoleGuest').checked) roles.push('guest');
            if (document.getElementById('editRoleUser').checked) roles.push('user');
            if (document.getElementById('editRoleAdmin').checked) roles.push('admin');

            let item;
            if (currentEditingItem.type === 'main') {
                item = navigationConfig.items.find(i => i.id === currentEditingItem.id);
            } else {
                const parentItem = navigationConfig.items.find(i => i.id === currentEditingItem.parentId);
                item = parentItem.submenu.find(i => i.id === currentEditingItem.id);
            }

            if (item) {
                item.label = label;
                item.icon = icon;
                item.action = action;
                item.target = target;
                item.roles = roles;

                // Save to localStorage
                localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));

                renderNavigationEditor();
                applyNavigationChanges(); // Update live navigation

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editMenuModal'));
                modal.hide();

                console.log('Menu item updated and saved:', item);
            }
        }

        function updateIconPreview() {
            const iconInput = document.getElementById('editMenuIcon');
            const preview = document.getElementById('editMenuIconPreview');

            if (iconInput && preview) {
                preview.className = iconInput.value || 'fas fa-cog';
            }
        }

        function toggleMenuItemVisibility(itemId) {
            const item = navigationConfig.items.find(i => i.id === itemId);
            if (item) {
                item.visible = !item.visible;

                // Save to localStorage
                localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));

                renderNavigationEditor();
                applyNavigationChanges(); // Update live navigation
                console.log(`Menu item ${itemId} visibility:`, item.visible);
            }
        }

        function toggleSubmenuItemVisibility(parentId, itemId) {
            const parentItem = navigationConfig.items.find(i => i.id === parentId);
            if (parentItem && parentItem.submenu) {
                const item = parentItem.submenu.find(i => i.id === itemId);
                if (item) {
                    item.visible = !item.visible;

                    // Save to localStorage
                    localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));

                    renderNavigationEditor();
                    applyNavigationChanges(); // Update live navigation
                    console.log(`Submenu item ${itemId} visibility:`, item.visible);
                }
            }
        }

        function deleteMenuItem(itemId) {
            if (confirm('Are you sure you want to delete this menu item?')) {
                navigationConfig.items = navigationConfig.items.filter(i => i.id !== itemId);

                // Save to localStorage
                localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));

                renderNavigationEditor();
                applyNavigationChanges(); // Update live navigation
                console.log(`Menu item ${itemId} deleted`);
            }
        }

        function deleteSubmenuItem(parentId, itemId) {
            if (confirm('Are you sure you want to delete this submenu item?')) {
                const parentItem = navigationConfig.items.find(i => i.id === parentId);
                if (parentItem && parentItem.submenu) {
                    parentItem.submenu = parentItem.submenu.filter(i => i.id !== itemId);

                    // Save to localStorage
                    localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));

                    renderNavigationEditor();
                    applyNavigationChanges(); // Update live navigation
                    console.log(`Submenu item ${itemId} deleted`);
                }
            }
        }

        function toggleRoleBasedNavigation() {
            const checkbox = document.getElementById('enableRoleBasedNav');
            const roleSettings = document.getElementById('roleSettings');

            navigationConfig.roleBasedVisibility = checkbox.checked;
            roleSettings.style.display = checkbox.checked ? 'block' : 'none';

            // Save to localStorage
            localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));

            applyNavigationChanges(); // Update live navigation
            console.log('Role-based navigation:', navigationConfig.roleBasedVisibility);
        }

        function loadRoleBasedSettings() {
            const checkbox = document.getElementById('enableRoleBasedNav');
            const roleSettings = document.getElementById('roleSettings');

            if (checkbox) {
                checkbox.checked = navigationConfig.roleBasedVisibility;
                roleSettings.style.display = navigationConfig.roleBasedVisibility ? 'block' : 'none';
            }
        }

        function expandAllMenus() {
            // This would expand all submenu items in the editor
            const submenuElements = document.querySelectorAll('.menu-item-submenu');
            submenuElements.forEach(el => {
                el.style.display = 'block';
            });
        }

        function collapseAllMenus() {
            // This would collapse all submenu items in the editor
            const submenuElements = document.querySelectorAll('.menu-item-submenu');
            submenuElements.forEach(el => {
                el.style.display = 'none';
            });
        }

        function previewNavigation() {
            // Generate a preview of how the navigation will look
            alert('Navigation preview would show here. This feature generates a live preview of the navigation based on current settings.');
        }

        function exportNavigationConfig() {
            const dataStr = JSON.stringify(navigationConfig, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'navigation-config.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function applyNavigationChanges() {
            console.log('Applying navigation changes to sidebar...');

            try {
                // Use current navigation configuration
                const items = navigationConfig.items || getDefaultNavigationConfig().items;

                // Get current user role (if any)
                const currentUser = getCurrentUser();
                const userRole = currentUser?.role || 'guest';

                console.log('Using navigation items:', items.length, 'User role:', userRole);

                // Get the navigation container
                const navContainer = document.querySelector('#sidebar .nav.nav-pills.flex-column');
                if (!navContainer) {
                    console.error('Navigation container not found');
                    return;
                }

                // Clear existing navigation items
                navContainer.innerHTML = '';

                // Build navigation HTML
                items.forEach(item => {
                    // Check if item should be visible for current user role
                    if (!shouldShowMenuItem(item, userRole)) {
                        console.log('Hiding item due to role restrictions:', item.label, 'for role:', userRole);
                        return;
                    }

                    console.log('Creating navigation item:', item.label);
                    const navItem = createNavigationItem(item);
                    navContainer.appendChild(navItem);
                });

                // Re-initialize navigation functionality
                initializeNavigationListeners();

                console.log('Navigation updated successfully');

                // Show visual notification
                showNavigationUpdateNotification();

                // Show success message
                const resultDiv = document.getElementById('navEditorResult');
                if (resultDiv) {
                    resultDiv.innerHTML =
                        '<div class="alert alert-success mt-2"><i class="fas fa-check me-2"></i>Navigation updated successfully!</div>';

                    setTimeout(() => {
                        resultDiv.innerHTML = '';
                    }, 3000);
                }

            } catch (error) {
                console.error('Error applying navigation changes:', error);

                const resultDiv = document.getElementById('navEditorResult');
                if (resultDiv) {
                    resultDiv.innerHTML =
                        '<div class="alert alert-danger mt-2"><i class="fas fa-exclamation-triangle me-2"></i>Error updating navigation: ' + error.message + '</div>';
                }
            }
        }

        function shouldShowMenuItem(item, userRole) {
            // If role-based navigation is disabled, show all items
            const roleBasedEnabled = navigationConfig?.roleBasedVisibility || false;
            if (!roleBasedEnabled) {
                return item.visible !== false;
            }

            // Check role-based visibility
            if (item.roles && item.roles.length > 0) {
                return item.roles.includes(userRole) && item.visible !== false;
            }

            // Default to visible if no roles specified
            return item.visible !== false;
        }

        function createNavigationItem(item) {
            const li = document.createElement('li');
            li.className = 'nav-item mb-2';

            if (item.submenu && item.submenu.length > 0) {
                // Create parent menu item with submenu
                li.className += ' nav-item-parent';
                li.id = item.id + 'NavParent';

                const link = document.createElement('a');
                link.className = 'nav-link text-white nav-link-parent';
                link.href = '#';
                link.onclick = () => { toggleSubmenu(item.id); return false; };

                link.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="${item.icon} me-2"></i>
                        ${item.label}
                    </div>
                    <i class="fas fa-chevron-right nav-chevron"></i>
                `;

                const submenuDiv = document.createElement('div');
                submenuDiv.className = 'nav-submenu';

                // Add submenu items
                item.submenu.forEach(child => {
                    if (shouldShowMenuItem(child, getCurrentUser()?.role || 'guest')) {
                        const sublink = document.createElement('a');
                        sublink.className = 'nav-sublink text-white';
                        sublink.href = '#';
                        sublink.onclick = () => {
                            if (child.action) {
                                executeMenuAction(child.action, child.target);
                            }
                            return false;
                        };
                        sublink.innerHTML = `
                            <i class="${child.icon}"></i>
                            ${child.label}
                        `;
                        submenuDiv.appendChild(sublink);
                    }
                });

                li.appendChild(link);
                li.appendChild(submenuDiv);

            } else {
                // Create regular menu item
                const link = document.createElement('a');
                link.className = 'nav-link text-white';
                if (item.id === 'dashboard') link.className += ' active';
                link.href = '#';
                link.onclick = () => {
                    if (item.action) {
                        executeMenuAction(item.action, item.target);
                    }
                    return false;
                };

                link.innerHTML = `
                    <i class="${item.icon} me-2"></i>
                    ${item.label}
                `;

                li.appendChild(link);
            }

            return li;
        }

        function executeMenuAction(action, target) {
            console.log('Executing menu action:', action, 'with target:', target);

            switch (action) {
                case 'section':
                case 'showSection':
                    if (target) {
                        showSection(target);
                    }
                    break;
                case 'openChatSection':
                    openChatSection();
                    break;
                case 'function':
                case 'testAPI':
                    if (target === 'testAPI' || action === 'testAPI') {
                        testAPI();
                    } else if (target && typeof window[target] === 'function') {
                        window[target]();
                    }
                    break;
                case 'url':
                    if (target) {
                        window.open(target, '_blank');
                    }
                    break;
                case 'submenu':
                    // Submenu actions are handled by toggleSubmenu
                    break;
                case 'customFunction':
                    if (target && typeof window[target] === 'function') {
                        window[target]();
                    }
                    break;
                default:
                    console.log('Unknown action:', action, 'target:', target);
                    // Try to call target as function if it exists
                    if (target && typeof window[target] === 'function') {
                        window[target]();
                    }
            }
        }

        function toggleSubmenu(menuId) {
            const parentElement = document.getElementById(menuId + 'NavParent');
            if (parentElement) {
                const isExpanded = parentElement.classList.contains('expanded');

                // Close all other submenus first
                document.querySelectorAll('.nav-item-parent.expanded').forEach(item => {
                    if (item !== parentElement) {
                        item.classList.remove('expanded');
                    }
                });

                // Toggle current submenu
                parentElement.classList.toggle('expanded');
            }
        }

        function getCurrentUser() {
            // Try to get current user from token or stored data
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    // Decode JWT token to get user info (simplified)
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return { role: payload.role || 'user', username: payload.username };
                } catch (e) {
                    console.log('Error decoding token:', e);
                }
            }
            return { role: 'guest', username: 'Guest' };
        }

        function initializeNavigationListeners() {
            // Re-initialize any global navigation listeners if needed
            // This ensures that dynamically created navigation items work properly
            console.log('Navigation listeners initialized');
        }

        function showNavigationUpdateNotification() {
            // Create or update the notification
            let notification = document.getElementById('navUpdateNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'navUpdateNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #198754;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999;
                    font-size: 14px;
                    font-weight: 500;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(notification);
            }

            notification.innerHTML = '<i class="fas fa-check me-2"></i>Navigation updated!';
            notification.style.opacity = '1';

            // Hide after 2 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }

        // Initialize the navigation editor when the nav-editor section is shown
        function initNavEditorWhenShown() {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const navEditor = document.getElementById('nav-editor');
                        if (navEditor && navEditor.style.display !== 'none') {
                            initializeNavigationEditor();
                            observer.disconnect(); // Stop observing once initialized
                        }
                    }
                });
            });

            const navEditor = document.getElementById('nav-editor');
            if (navEditor) {
                observer.observe(navEditor, { attributes: true });
            }
        }

        // Legacy function kept for compatibility
        function saveNavConfig() {
            saveNavigationConfig();
        }

        function resetNavConfig() {
            resetNavigationToDefault();
        }

        // Load saved configurations on page load
        function loadSavedConfigurations() {
            // Load AI config
            const savedAIConfig = localStorage.getItem('aiConfig');
            if (savedAIConfig) {
                try {
                    const config = JSON.parse(savedAIConfig);
                    if (document.getElementById('configLangflowUrl')) {
                        document.getElementById('configLangflowUrl').value = config.langflowUrl || 'http://10.88.4.25:7860';
                        document.getElementById('configFlowId').value = config.flowId || '900b0d89-4481-4f64-88bf-4d4661086a62';
                        document.getElementById('configApiKey').value = config.apiKey || '';
                        document.getElementById('configDefaultModel').value = config.defaultModel || 'gpt-3.5-turbo';
                        document.getElementById('configTimeout').value = config.timeout || '30';
                        document.getElementById('configMaxRetries').value = config.maxRetries || '3';
                    }
                } catch (e) {
                    console.log('Error loading AI config:', e);
                }
            }

            // Load file config
            const savedFileConfig = localStorage.getItem('fileConfig');
            if (savedFileConfig) {
                try {
                    const config = JSON.parse(savedFileConfig);
                    if (document.getElementById('configMaxFileSize')) {
                        document.getElementById('configMaxFileSize').value = config.maxFileSize || '10';
                        document.getElementById('configMaxFiles').value = config.maxFiles || '5';
                        if (config.allowedTypes) {
                            document.getElementById('allowTxt').checked = config.allowedTypes.txt !== false;
                            document.getElementById('allowPdf').checked = config.allowedTypes.pdf !== false;
                            document.getElementById('allowDoc').checked = config.allowedTypes.doc !== false;
                            document.getElementById('allowCsv').checked = config.allowedTypes.csv !== false;
                            document.getElementById('allowJson').checked = config.allowedTypes.json !== false;
                            document.getElementById('allowMd').checked = config.allowedTypes.md !== false;
                            document.getElementById('allowXls').checked = config.allowedTypes.xls === true;
                            document.getElementById('allowImages').checked = config.allowedTypes.images === true;
                        }
                        document.getElementById('configUploadEndpoint').value = config.uploadEndpoint || '/api/v2/files/';
                        document.getElementById('configUploadTimeout').value = config.uploadTimeout || '60';
                        document.getElementById('configFallbackEnabled').checked = config.fallbackEnabled !== false;

                        // Load Langflow destination path settings
                        document.getElementById('configDestinationComponent').value = config.destinationComponent || 'File-QW4Au';
                        document.getElementById('configDestinationInput').value = config.destinationInput || 'path';
                        document.getElementById('configDestinationPath').value = config.destinationPath || 'File-QW4Au.path';

                        // Apply the loaded configuration immediately
                        applyFileConfigChanges(config);
                    }
                } catch (e) {
                    console.log('Error loading file config:', e);
                }
            } else {
                // Apply default configuration if none saved
                const defaultConfig = {
                    maxFileSize: '10',
                    maxFiles: '5',
                    allowedTypes: {
                        txt: true,
                        pdf: true,
                        doc: true,
                        csv: true,
                        json: true,
                        md: true,
                        xls: false,
                        images: false
                    },
                    uploadEndpoint: '/api/v2/files/',
                    uploadTimeout: '60',
                    fallbackEnabled: true,
                    destinationComponent: 'File-QW4Au',
                    destinationInput: 'path',
                    destinationPath: 'File-QW4Au.path'
                };
                applyFileConfigChanges(defaultConfig);
            }
        }

        // Set up live configuration updates
        function setupLiveConfigurationUpdates() {
            // File type checkboxes - live updates
            const fileTypeCheckboxes = [
                'allowTxt', 'allowPdf', 'allowDoc', 'allowCsv',
                'allowJson', 'allowMd', 'allowXls', 'allowImages'
            ];

            fileTypeCheckboxes.forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        const currentConfig = getCurrentFileConfig();
                        applyFileConfigChanges(currentConfig);
                        console.log('File type configuration updated live');
                    });
                }
            });

            // AI model selection - live updates
            const modelSelector = document.getElementById('configDefaultModel');
            if (modelSelector) {
                modelSelector.addEventListener('change', function() {
                    // Update model badge immediately
                    const savedConfig = JSON.parse(localStorage.getItem('aiConfig') || '{}');
                    savedConfig.defaultModel = this.value;
                    localStorage.setItem('aiConfig_defaultModel', this.value);
                    updateModelBadge();
                    console.log('AI model updated live:', this.value);
                });
            }
        }

        function getCurrentFileConfig() {
            return {
                maxFileSize: document.getElementById('configMaxFileSize')?.value || '10',
                maxFiles: document.getElementById('configMaxFiles')?.value || '5',
                allowedTypes: {
                    txt: document.getElementById('allowTxt')?.checked || false,
                    pdf: document.getElementById('allowPdf')?.checked || false,
                    doc: document.getElementById('allowDoc')?.checked || false,
                    csv: document.getElementById('allowCsv')?.checked || false,
                    json: document.getElementById('allowJson')?.checked || false,
                    md: document.getElementById('allowMd')?.checked || false,
                    xls: document.getElementById('allowXls')?.checked || false,
                    images: document.getElementById('allowImages')?.checked || false
                },
                uploadEndpoint: document.getElementById('configUploadEndpoint')?.value || '/api/v2/files/',
                uploadTimeout: document.getElementById('configUploadTimeout')?.value || '60',
                fallbackEnabled: document.getElementById('configFallbackEnabled')?.checked || true,
                destinationComponent: document.getElementById('configDestinationComponent')?.value || 'File-QW4Au',
                destinationInput: document.getElementById('configDestinationInput')?.value || 'path',
                destinationPath: document.getElementById('configDestinationPath')?.value || 'File-QW4Au.path'
            };
        }

        // Auto-generate destination path when component or input changes
        function setupDestinationPathUpdates() {
            const componentField = document.getElementById('configDestinationComponent');
            const inputField = document.getElementById('configDestinationInput');
            const pathField = document.getElementById('configDestinationPath');

            function updateDestinationPath() {
                if (componentField && inputField && pathField) {
                    const component = componentField.value || 'File-QW4Au';
                    const input = inputField.value || 'path';
                    pathField.value = `${component}.${input}`;
                }
            }

            if (componentField) {
                componentField.addEventListener('input', updateDestinationPath);
            }
            if (inputField) {
                inputField.addEventListener('input', updateDestinationPath);
            }
        }

        // Simple test function for debugging navigation
        function testNavigation() {
            console.log('=== Navigation Test ===');
            console.log('Available sections:');
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                console.log(`- ${section.id}: ${section.style.display || 'visible'}`);
            });

            console.log('Available nav links:');
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach((link, index) => {
                console.log(`- Link ${index}: ${link.textContent.trim()}`);
            });

            console.log('Current navigation config:', navigationConfig);
            console.log('Saved navigation config:', localStorage.getItem('navigationConfig'));

            alert('Navigation test complete! Check console for details.');
        }

        // Debug function to force save navigation config
        function debugSaveNavigation() {
            console.log('Debug: Force saving navigation config');
            localStorage.setItem('navigationConfig', JSON.stringify(navigationConfig));
            console.log('Saved config:', localStorage.getItem('navigationConfig'));
            applyNavigationChanges();
            alert('Navigation config force saved and applied!');
        }

        // Debug function to force load navigation config
        function debugLoadNavigation() {
            console.log('Debug: Force loading navigation config');
            loadNavigationConfig();
            applyNavigationChanges();
            console.log('Loaded config:', navigationConfig);
            alert('Navigation config force loaded and applied!');
        }

        // Global function to manually show sections (for console testing)
        window.showSectionManual = function(sectionId) {
            return showSection(sectionId);
        };

        // User Dropdown Functions
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const isShow = dropdown.classList.contains('show');

            // Close all other dropdowns first
            closeAllDropdowns();

            if (!isShow) {
                dropdown.classList.add('show');
                // Close dropdown when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeUserDropdownOnClickOutside);
                }, 0);
            }
        }

        function closeUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');
            document.removeEventListener('click', closeUserDropdownOnClickOutside);
        }

        function closeUserDropdownOnClickOutside(event) {
            const dropdown = document.getElementById('userDropdown');
            if (!dropdown.contains(event.target)) {
                closeUserDropdown();
            }
        }

        function closeAllDropdowns() {
            closeUserDropdown();
        }

        function updateUserDropdown(user = null) {
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            const mobileUserAvatar = document.getElementById('mobileUserAvatar');
            const guestMenu = document.getElementById('guestMenu');
            const authenticatedMenu = document.getElementById('authenticatedMenu');
            const authUserAvatar = document.getElementById('authUserAvatar');
            const authUserInitials = document.getElementById('authUserInitials');
            const authUserName = document.getElementById('authUserName');
            const authUserRole = document.getElementById('authUserRole');
            const userMgmtMenuItem = document.getElementById('userMgmtMenuItem');

            if (user && user.username) {
                // User is authenticated
                const initials = user.display_name ?
                    user.display_name.split(' ').map(n => n[0]).join('').toUpperCase() :
                    user.username.substring(0, 2).toUpperCase();

                const displayName = user.display_name || user.username;
                const roles = user.roles ? user.roles.join(', ') : 'user';
                const isAdmin = user.roles && user.roles.includes('admin');

                // Update main toggle
                userAvatar.className = 'user-avatar';
                userAvatar.innerHTML = initials;
                userName.textContent = displayName;
                userRole.textContent = roles;

                // Update mobile avatar
                mobileUserAvatar.className = 'user-avatar';
                mobileUserAvatar.innerHTML = initials;

                // Update dropdown header
                authUserAvatar.className = 'user-avatar';
                authUserInitials.textContent = initials;
                authUserName.textContent = displayName;
                authUserRole.textContent = roles;

                // Show/hide menu items
                guestMenu.style.display = 'none';
                authenticatedMenu.style.display = 'block';
                userMgmtMenuItem.style.display = isAdmin ? 'block' : 'none';

                console.log('User dropdown updated for authenticated user:', displayName);
            } else {
                // User is not authenticated (guest)
                userAvatar.className = 'user-avatar guest';
                userAvatar.innerHTML = '<i class="fas fa-user"></i>';
                userName.textContent = 'Guest User';
                userRole.textContent = 'Not Authenticated';

                // Update mobile avatar
                mobileUserAvatar.className = 'user-avatar guest';
                mobileUserAvatar.innerHTML = '<i class="fas fa-user"></i>';

                // Show guest menu
                guestMenu.style.display = 'block';
                authenticatedMenu.style.display = 'none';

                console.log('User dropdown updated for guest user');
            }
        }

        function logoutUser() {
            // Clear token and user data
            localStorage.removeItem('token');

            // Update UI to guest state
            updateUserDropdown();

            // Show dashboard section
            showSection('dashboard');

            // Show success message
            setTimeout(() => {
                alert('You have been logged out successfully.');
            }, 300);

            console.log('User logged out');
        }

        // Initialize user dropdown on page load
        function initializeUserDropdown() {
            const token = localStorage.getItem('token');
            if (token) {
                // Verify token and get user info
                fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.user) {
                        updateUserDropdown(data.user);
                    } else {
                        // Token invalid, clear it
                        localStorage.removeItem('token');
                        updateUserDropdown();
                    }
                })
                .catch(error => {
                    console.log('Token verification failed:', error);
                    localStorage.removeItem('token');
                    updateUserDropdown();
                });
            } else {
                updateUserDropdown();
            }
        }

        // Handle login form
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('authResult');

            resultDiv.innerHTML = '<div class="alert alert-info">Attempting login...</div>';

            fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Login Successful!</strong><br>
                            Welcome, ${data.user.display_name || data.user.username}!<br>
                            Roles: ${data.user.roles.join(', ')}
                        </div>
                    `;
                    localStorage.setItem('token', data.token);

                    // Update user dropdown with authenticated user info
                    updateUserDropdown(data.user);

                    // Debug: Log user roles
                    console.log('User logged in with roles:', data.user.roles);

                    // Show user management interface if user has admin role
                    if (data.user.roles.includes('admin')) {
                        console.log('Admin detected, redirecting to user management interface');

                        // Hide all sections first
                        document.querySelectorAll('.content-section').forEach(section => {
                            section.style.display = 'none';
                        });

                        // Remove active class from all nav links
                        document.querySelectorAll('.nav-link').forEach(link => {
                            link.classList.remove('active');
                        });

                        // Show user management section
                        document.getElementById('users').style.display = 'block';

                        // Make user management nav link active
                        document.querySelector('a[onclick="showSection(\'users\')"]').classList.add('active');

                        // Show the user management interface
                        document.getElementById('userMgmtAuth').style.display = 'none';
                        document.getElementById('userMgmtInterface').style.display = 'block';
                        loadUsers(); // Load users immediately after login
                    } else {
                        console.log('Not admin user, staying on current section');
                        // For non-admin users, just stay where they are or go to dashboard
                        showSection('dashboard');
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Login Failed:</strong> ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Connection Error:</strong> ${error.message}<br>
                        <small>Make sure the admin user is initialized with: <code>python init_admin.py</code></small>
                    </div>
                `;
            });
        });

        // User Management Functions
        function loadUsers() {
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('usersList').innerHTML = '<div class="alert alert-warning">Please login first</div>';
                return;
            }

            document.getElementById('usersList').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading users...</div>';

            fetch('/api/users', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Users API response:', data);
                if (data.success) {
                    console.log('Users data:', data.users);
                    let usersHtml = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Username</th><th>Display Name</th><th>Email</th><th>Roles</th><th>Status</th><th>Actions</th></tr></thead><tbody>';

                    data.users.forEach(user => {
                        console.log('Processing user:', user);
                        // Handle both status formats
                        const isActive = user.is_active !== undefined ? user.is_active : (user.status === 'active');

                        usersHtml += `
                            <tr>
                                <td><strong>${user.username}</strong></td>
                                <td>${user.display_name || '-'}</td>
                                <td>${user.email || '-'}</td>
                                <td><span class="badge bg-primary">${user.roles.join(', ')}</span></td>
                                <td><span class="badge ${isActive ? 'bg-success' : 'bg-danger'}">${isActive ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.username}')" ${user.username === 'admin' ? 'disabled' : ''}>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    usersHtml += '</tbody></table></div>';
                    document.getElementById('usersList').innerHTML = usersHtml;
                } else {
                    document.getElementById('usersList').innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('usersList').innerHTML = `<div class="alert alert-danger">Connection error: ${error.message}</div>`;
            });
        }

        function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
                return;
            }

            const token = localStorage.getItem('token');
            fetch(`/api/users/${username}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadUsers(); // Refresh the list
                } else {
                    alert('Error deleting user: ' + data.message);
                }
            })
            .catch(error => {
                alert('Connection error: ' + error.message);
            });
        }

        // Handle create user form
        document.getElementById('createUserForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('createUserResult').innerHTML = '<div class="alert alert-warning">Please login first</div>';
                return;
            }

            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const displayName = document.getElementById('newDisplayName').value;
            const email = document.getElementById('newEmail').value;

            const roles = [];
            if (document.getElementById('roleUser').checked) roles.push('user');
            if (document.getElementById('roleAdmin').checked) roles.push('admin');

            const resultDiv = document.getElementById('createUserResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Creating user...</div>';

            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    display_name: displayName,
                    email: email,
                    roles: roles
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success">User created successfully!</div>';
                    document.getElementById('createUserForm').reset();
                    document.getElementById('roleUser').checked = true; // Reset to default
                    loadUsers(); // Refresh the list
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="alert alert-danger">Connection error: ${error.message}</div>`;
            });
        });

        // Check if already logged in when switching to user management
        function checkAuthForUserMgmt() {
            console.log('Checking authentication for user management...');
            const token = localStorage.getItem('token');
            if (token) {
                console.log('Token found, verifying...');
                // Verify token is still valid
                fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Verify response:', data);
                    if (data.success && data.user.roles.includes('admin')) {
                        console.log('Admin verified, showing user management');
                        document.getElementById('userMgmtAuth').style.display = 'none';
                        document.getElementById('userMgmtInterface').style.display = 'block';
                        loadUsers();
                    } else {
                        console.log('Not admin or verification failed');
                    }
                })
                .catch(error => {
                    console.log('Verification error:', error);
                });
            } else {
                console.log('No token found');
            }
        }

        // Handle file upload
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('uploadResult');

            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please select a file first.</div>';
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            resultDiv.innerHTML = '<div class="alert alert-info">Uploading file...</div>';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Upload Successful!</strong><br>
                            File: ${data.filename}<br>
                            Rows: ${data.rows}<br>
                            Columns: ${data.columns.join(', ')}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Upload Failed:</strong> ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Upload Error:</strong> ${error.message}
                    </div>
                `;
            });
        });

        // Chat functionality
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        let isWaitingForResponse = false;
        let attachedFiles = [];

        // Initialize chat
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing application...');

            // Initialize user dropdown first
            try {
                initializeUserDropdown();
            } catch (error) {
                console.error('Error initializing user dropdown:', error);
            }

            // Load and apply navigation configuration
            try {
                console.log('Loading navigation configuration...');
                loadNavigationConfig();
                applyNavigationChanges();
                console.log('Navigation configuration loaded and applied');
            } catch (error) {
                console.error('Error loading navigation configuration:', error);
            }

            // Test if basic functions work
            console.log('Testing navigation functions...');

            // Initialize chat functions
            try {
                updateWelcomeTime();
                loadChatHistory();
                updateModelBadge();
                initializeFileUpload();
            } catch (error) {
                console.error('Error initializing chat:', error);
            }

            // Add click event listeners as backup for navigation
            try {
                addNavigationListeners();
            } catch (error) {
                console.error('Error adding navigation listeners:', error);
            }

            // Initialize navigation editor observer
            try {
                initNavEditorWhenShown();
            } catch (error) {
                console.error('Error initializing navigation editor:', error);
            }

            // Load saved configurations
            try {
                loadSavedConfigurations();
                setupLiveConfigurationUpdates();
                setupDestinationPathUpdates();
            } catch (error) {
                console.error('Error loading saved configurations:', error);
            }

            // Load application settings
            try {
                loadApplicationSettings();
            } catch (error) {
                console.error('Error loading application settings:', error);
            }
        });

        // Backup navigation listeners in case onclick doesn't work
        function addNavigationListeners() {
            const navLinks = document.querySelectorAll('.nav-link[onclick*="showSection"]');
            console.log('Found nav links for backup listeners:', navLinks.length);

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const onclick = this.getAttribute('onclick');
                    const match = onclick.match(/showSection\('([^']+)'\)/);
                    if (match) {
                        const sectionId = match[1];
                        console.log('Backup listener triggered for section:', sectionId);
                        showSection(sectionId);
                    }
                });
            });

            // Special handler for chat section
            const chatLink = document.querySelector('.nav-link[onclick*="openChatSection"]');
            if (chatLink) {
                chatLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Backup chat listener triggered');
                    openChatSection();
                });
            }
        }

        function initializeFileUpload() {
            const fileInput = document.getElementById('chatFileInput');
            const uploadArea = document.getElementById('fileUploadArea');
            const inputContainer = document.querySelector('.chat-input-container');

            // File input change handler
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop handlers on the entire input container
            inputContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.display = 'block';
                uploadArea.classList.add('dragover');
            });

            inputContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                // Only hide if we're leaving the container entirely
                if (!inputContainer.contains(e.relatedTarget)) {
                    uploadArea.style.display = 'none';
                    uploadArea.classList.remove('dragover');
                }
            });

            inputContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.display = 'none';
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFiles(files);
                }
            });
        }

        function handleFileSelect(event) {
            handleFiles(event.target.files);
        }

        function handleFiles(files) {
            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    continue;
                }

                addFileAttachment(file);
            }
        }

        function addFileAttachment(file) {
            const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const fileObj = {
                id: fileId,
                file: file,
                name: file.name,
                size: file.size,
                type: file.type,
                content: null
            };

            console.log('Adding file attachment:', fileObj);
            attachedFiles.push(fileObj);

            // Read file content if it's a text-based file
            if (isTextFile(file)) {
                console.log('Reading text file:', file.name);
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileObj.content = e.target.result;
                    console.log('File content loaded:', file.name, fileObj.content.length + ' characters');
                };
                reader.onerror = function(e) {
                    console.error('Error reading file:', file.name, e);
                };
                reader.readAsText(file);
            } else {
                console.log('Skipping binary file:', file.name);
            }

            displayFileAttachments();
        }

        function isTextFile(file) {
            const textTypes = ['text/', 'application/json', 'application/csv', 'application/xml'];
            const textExtensions = ['.txt', '.md', '.csv', '.json', '.log', '.xml', '.yaml', '.yml', '.py', '.js', '.html', '.css'];

            // Check MIME type
            if (textTypes.some(type => file.type.startsWith(type))) {
                return true;
            }

            // Check file extension
            if (textExtensions.some(ext => file.name.toLowerCase().endsWith(ext))) {
                return true;
            }

            // Default to false for safety
            return false;
        }

        function getFileIcon(fileName, fileType) {
            const ext = fileName.toLowerCase().split('.').pop();

            if (['pdf'].includes(ext)) return 'pdf';
            if (['doc', 'docx'].includes(ext)) return 'doc';
            if (['txt', 'md', 'log'].includes(ext)) return 'txt';
            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'image';
            return 'default';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function displayFileAttachments() {
            const container = document.getElementById('fileAttachments');

            if (attachedFiles.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            container.innerHTML = '';

            attachedFiles.forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-attachment';

                const iconType = getFileIcon(file.name, file.type);
                const iconMap = {
                    'pdf': 'fas fa-file-pdf',
                    'doc': 'fas fa-file-word',
                    'txt': 'fas fa-file-alt',
                    'image': 'fas fa-file-image',
                    'default': 'fas fa-file'
                };

                fileDiv.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon ${iconType}">
                            <i class="${iconMap[iconType]}"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button class="remove-file" onclick="removeFileAttachment('${file.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                container.appendChild(fileDiv);
            });
        }

        function removeFileAttachment(fileId) {
            attachedFiles = attachedFiles.filter(file => file.id !== fileId);
            displayFileAttachments();
        }

        function updateWelcomeTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('welcomeTime').textContent = timeString;
        }

        function updateModelBadge() {
            // Get model from saved configuration
            let model = localStorage.getItem('aiConfig_defaultModel') || 'gpt-3.5-turbo';

            // Try to get from saved config if not found
            const savedConfig = localStorage.getItem('aiConfig');
            if (savedConfig && !localStorage.getItem('aiConfig_defaultModel')) {
                try {
                    const config = JSON.parse(savedConfig);
                    model = config.defaultModel || 'gpt-3.5-turbo';
                } catch (e) {
                    model = 'gpt-3.5-turbo';
                }
            }

            const badge = document.getElementById('modelBadge');
            const modelNames = {
                'gpt-3.5-turbo': 'GPT-3.5',
                'gpt-4': 'GPT-4',
                'claude-3': 'Claude 3',
                'llama-2': 'Llama 2'
            };
            badge.textContent = modelNames[model] || 'AI';
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if ((!message && attachedFiles.length === 0) || isWaitingForResponse) return;

            // Create message content with attachments for display
            let messageContent = message;
            let attachmentInfo = '';

            if (attachedFiles.length > 0) {
                attachmentInfo = attachedFiles.map(file => {
                    let content = '';
                    if (file.content) {
                        // Truncate content for display only
                        const truncated = file.content.length > 200 ?
                            file.content.substring(0, 200) + '...' : file.content;
                        content = `\nContent preview: ${truncated}`;
                    }
                    return `ð ${file.name} (${formatFileSize(file.size)})${content}`;
                }).join('\n');
            }

            // Add user message with attachments for display
            const displayMessage = message + (attachmentInfo ? '\n\n' + attachmentInfo : '');
            addMessageToChat('user', displayMessage);

            // Store current attachments for Langflow
            const currentFiles = [...attachedFiles];

            input.value = '';
            input.style.height = 'auto';

            // Clear attachments UI after sending (but keep reference for Langflow)
            attachedFiles = [];
            displayFileAttachments();

            // Save to history
            chatHistory.push({
                type: 'user',
                content: displayMessage,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

            // Send to Langflow with original message and files
            sendToLangflowWithFiles(message, currentFiles);
        }

        async function sendToLangflowWithFiles(message, files) {
            console.log('sendToLangflowWithFiles called with:', { message, files: files?.length || 0 });

            // Declare and initialize URLs at function scope to avoid scoping issues
            let baseUrl = null;
            let localBaseUrl = null;

            try {
                localBaseUrl = `${window.location.protocol}//${window.location.host}`;
                console.log('Local base URL initialized:', localBaseUrl);
            } catch (urlError) {
                console.error('Error initializing local base URL:', urlError);
                addMessageToChat('bot', 'â Configuration error: Could not determine local URL.');
                return;
            }

            // Get configuration from AI Configuration section or saved localStorage
            let langflowUrl = document.getElementById('configLangflowUrl')?.value || localStorage.getItem('aiConfig_langflowUrl') || 'http://10.88.4.25:7860';
            let flowId = document.getElementById('configFlowId')?.value || localStorage.getItem('aiConfig_flowId') || '900b0d89-4481-4f64-88bf-4d4661086a62';
            let apiKey = document.getElementById('configApiKey')?.value || localStorage.getItem('aiConfig_apiKey') || '';

            // Try to get from saved config if not in form
            const savedConfig = localStorage.getItem('aiConfig');
            if (savedConfig && (!langflowUrl || !flowId)) {
                try {
                    const config = JSON.parse(savedConfig);
                    langflowUrl = langflowUrl || config.langflowUrl || 'http://10.88.4.25:7860';
                    flowId = flowId || config.flowId || '900b0d89-4481-4f64-88bf-4d4661086a62';
                    apiKey = apiKey || config.apiKey || '';
                } catch (e) {
                    console.log('Error parsing saved config:', e);
                }
            }

            if (!langflowUrl || !flowId) {
                addMessageToChat('bot', 'â ï¸ Please configure Langflow URL and Flow ID in Configuration â AI Configuration.');
                return;
            }

            // Extract base URL from the langflowUrl (remove /api/v1/run or similar paths)
            try {
                const url = new URL(langflowUrl);
                baseUrl = `${url.protocol}//${url.host}`;
                console.log('Base Langflow URL initialized:', baseUrl);
                console.log('Local Flask URL initialized:', localBaseUrl);
            } catch (urlError) {
                console.error('Invalid Langflow URL:', urlError);
                addMessageToChat('bot', 'â Invalid Langflow URL format. Please check your configuration.');
                isWaitingForResponse = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('chatStatus').textContent = 'Ready';
                return;
            }

            // Ensure URLs are available for file uploads
            if (!baseUrl || !localBaseUrl) {
                console.error('URLs not properly initialized', { baseUrl, localBaseUrl });
                addMessageToChat('bot', 'â Configuration error: URLs not properly initialized. Please check your configuration.');
                isWaitingForResponse = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('chatStatus').textContent = 'Ready';
                return;
            }

            isWaitingForResponse = true;
            document.getElementById('sendButton').disabled = true;
            showTypingIndicator();
            document.getElementById('chatStatus').textContent = 'Processing files and thinking...';

            try {
                // Prepare the base request body
                const requestBody = {
                    input_value: message,
                    output_type: "chat",
                    input_type: "chat",
                    tweaks: {}
                };

                // Step 1: Upload files to Langflow if any files are attached
                if (files && files.length > 0) {
                    console.log('Starting file upload process...');
                    console.log('Available URLs:', { baseUrl, localBaseUrl });
                    console.log('Files to upload:', files.map(f => f.name));

                    // For the first file, upload it properly to Langflow
                    const firstFile = files[0];

                    if (firstFile.file) {
                        // This is an actual File object - try multiple upload methods
                        try {
                            console.log('Uploading binary file:', firstFile.name);
                            console.log('File object:', firstFile.file);
                            console.log('Current URLs available:', { baseUrl, localBaseUrl });

                            // Double-check URLs before proceeding with file upload
                            if (!baseUrl || !localBaseUrl) {
                                const errorMsg = `URLs not initialized properly in file upload: baseUrl=${baseUrl}, localBaseUrl=${localBaseUrl}`;
                                console.error(errorMsg);
                                throw new Error(errorMsg);
                            }

                            // Create FormData for file upload
                            const formData = new FormData();
                            formData.append('file', firstFile.file);

                            // Upload headers
                            const uploadHeaders = {
                                'Accept': 'application/json'
                            };

                            if (apiKey) {
                                uploadHeaders['x-api-key'] = apiKey;
                            }

                            let uploadResponse;
                            let successfulEndpoint;

                            // Try file upload - Start with local Flask server
                            const localEndpoints = [
                                `${localBaseUrl}/api/v2/files/`,
                                `${localBaseUrl}/upload`
                            ];

                            console.log('Trying local Flask endpoints first:', localEndpoints);

                            for (let i = 0; i < localEndpoints.length; i++) {
                                const endpoint = localEndpoints[i];
                                try {
                                    console.log(`[${i+1}/${localEndpoints.length}] Trying local: ${endpoint}`);

                                    uploadResponse = await fetch(endpoint, {
                                        method: 'POST',
                                        headers: uploadHeaders,
                                        body: formData
                                    });

                                    console.log(`Response status: ${uploadResponse.status} ${uploadResponse.statusText}`);

                                    if (uploadResponse.ok) {
                                        successfulEndpoint = endpoint;
                                        console.log(`â Upload successful with local endpoint: ${endpoint}`);
                                        break;
                                    } else {
                                        console.log(`â Local endpoint failed with status ${uploadResponse.status}: ${uploadResponse.statusText}`);
                                        const errorText = await uploadResponse.text();
                                        console.log(`Local error response: ${errorText}`);
                                    }
                                } catch (endpointError) {
                                    console.log(`â Network error with local ${endpoint}:`, endpointError.message);
                                    continue;
                                }
                            }

                            // If local failed, try Langflow endpoints as fallback
                            if (!uploadResponse || !uploadResponse.ok) {
                                console.log('Local upload failed, trying Langflow endpoints...');
                                const langflowEndpoints = [
                                    `${baseUrl}/api/v2/files/`,
                                    `${baseUrl}/api/v1/files/`
                                ];

                                for (let i = 0; i < langflowEndpoints.length; i++) {
                                    const endpoint = langflowEndpoints[i];
                                    try {
                                        console.log(`[${i+1}/${langflowEndpoints.length}] Trying Langflow: ${endpoint}`);

                                        uploadResponse = await fetch(endpoint, {
                                            method: 'POST',
                                            headers: uploadHeaders,
                                            body: formData
                                        });

                                        if (uploadResponse.ok) {
                                            successfulEndpoint = endpoint;
                                            console.log(`â Upload successful with Langflow: ${endpoint}`);
                                            break;
                                        }
                                    } catch (endpointError) {
                                        console.log(`â Langflow endpoint error:`, endpointError.message);
                                        continue;
                                    }
                                }
                            }

                            if (!uploadResponse || !uploadResponse.ok) {
                                const errorMsg = `All file upload endpoints failed. Your Langflow server may not support file uploads.`;
                                console.error(errorMsg);
                                throw new Error(errorMsg);
                            }

                            // Get response text first to handle parsing errors better
                            const uploadResponseText = await uploadResponse.text();
                            console.log('Raw upload response:', uploadResponseText);

                            let uploadData;
                            try {
                                uploadData = JSON.parse(uploadResponseText);
                                console.log('â File upload response:', uploadData);
                            } catch (parseError) {
                                console.error('Upload response JSON parsing error:', parseError);
                                console.error('Upload response was not valid JSON:', uploadResponseText);

                                // Check if response looks like HTML (common server error)
                                if (uploadResponseText.trim().startsWith('<')) {
                                    throw new Error(`File upload failed: Server returned HTML instead of JSON. Check if the upload endpoint exists and your server is configured correctly.`);
                                } else {
                                    throw new Error(`File upload failed: Server returned invalid JSON. Response: ${uploadResponseText.substring(0, 100)}...`);
                                }
                            }

                            // Get the uploaded file path (handle different response formats)
                            const uploadedPath = uploadData.path || uploadData.file_path || uploadData.url || uploadData.id;

                            if (uploadedPath) {
                                // Normalize path separators for cross-platform compatibility
                                // Convert Windows backslashes to Unix forward slashes for Langflow
                                let normalizedPath = uploadedPath.replace(/\\/g, '/');

                                // Additional path cleaning - remove any double slashes and ensure proper format
                                normalizedPath = normalizedPath.replace(/\/+/g, '/'); // Replace multiple slashes with single slash

                                // If path doesn't start with /, ensure it's a relative path for Langflow
                                if (normalizedPath.startsWith('/')) {
                                    // For absolute paths, try to extract just the relative part after uploads
                                    const uploadsIndex = normalizedPath.lastIndexOf('/uploads/');
                                    if (uploadsIndex !== -1) {
                                        normalizedPath = normalizedPath.substring(uploadsIndex + 1); // Keep 'uploads/filename'
                                    }
                                }

                                // Get configured component ID for file destination
                                const fileConfig = JSON.parse(localStorage.getItem('fileConfig') || '{}');
                                const componentId = fileConfig.destinationComponent || 'File-QW4Au';

                                // Set the file path in tweaks for the File component
                                requestBody.tweaks[componentId] = {
                                    "path": normalizedPath
                                };
                                console.log('ð§ Component ID:', componentId);
                                console.log('ð Original server path:', uploadedPath);
                                console.log('â Final normalized path:', normalizedPath);
                                console.log('ð Full tweaks object:', JSON.stringify(requestBody.tweaks, null, 2));
                                addMessageToChat('bot', `ð File uploaded successfully: ${firstFile.name} â ${normalizedPath}`);
                            } else {
                                console.warn('â ï¸ No file path returned from upload, falling back to content method');
                                throw new Error('No file path returned from upload');
                            }

                        } catch (uploadError) {
                            console.error('â File upload error:', uploadError);

                            // Fallback: Read file content and include in message if it's a text file
                            if (isTextFile(firstFile.file)) {
                                console.log('ð Falling back to text content method for:', firstFile.name);
                                try {
                                    const fileReader = new FileReader();
                                    const fileContent = await new Promise((resolve, reject) => {
                                        fileReader.onload = e => resolve(e.target.result);
                                        fileReader.onerror = reject;
                                        fileReader.readAsText(firstFile.file);
                                    });

                                    firstFile.content = fileContent;
                                    console.log('â File content read successfully, length:', fileContent.length);

                                    // Include content in the message as fallback
                                    const fileContents = `--- File: ${firstFile.name} ---\n${fileContent}\n--- End of ${firstFile.name} ---`;
                                    requestBody.input_value = `${message}\n\n--- ATTACHED FILE CONTENT ---\n${fileContents}\n--- END ATTACHED FILE ---`;

                                    addMessageToChat('bot', `â ï¸ File upload failed, but included text content from: ${firstFile.name}`);

                                } catch (readError) {
                                    console.error('â Failed to read file content:', readError);
                                    addMessageToChat('bot', `â Failed to upload file and couldn't read content: ${uploadError.message}. Please check your Langflow configuration.`);
                                    return;
                                }
                            } else {
                                console.error('â Binary file upload failed:', uploadError);
                                console.log('Debug info:', {
                                    baseUrl,
                                    localBaseUrl,
                                    uploadError: uploadError.message,
                                    stack: uploadError.stack
                                });
                                addMessageToChat('bot', `â Failed to upload binary file: ${uploadError.message}. Debug: baseUrl=${baseUrl}, localBaseUrl=${localBaseUrl}. Your Langflow server may not support file uploads. Only text files can be included as fallback.`);
                                return;
                            }
                        }
                    } else if (firstFile.content) {
                        // This is text content - create a temporary file and upload it
                        try {
                            console.log('Creating blob for text file:', firstFile.name);

                            // Create a blob from the text content
                            const blob = new Blob([firstFile.content], { type: 'text/plain' });
                            const file = new File([blob], firstFile.name, { type: 'text/plain' });

                            // Create FormData for file upload
                            const formData = new FormData();
                            formData.append('file', file);

                            // Upload headers
                            const uploadHeaders = {
                                'Accept': 'application/json'
                            };

                            if (apiKey) {
                                uploadHeaders['x-api-key'] = apiKey;
                            }

                            let uploadResponse;
                            let uploadEndpoint;

                            // Try different file upload endpoints
                            // Upload to local Flask server first
                            const endpoints = [
                                `${localBaseUrl}/api/v2/files/`,
                                `${localBaseUrl}/api/v1/files/`,
                                `${localBaseUrl}/files/`,
                                `${localBaseUrl}/upload`,
                                `${baseUrl}/api/v2/files/`,      // Langflow fallbacks
                                `${baseUrl}/api/v1/files/`,
                                `${baseUrl}/files/`,
                                `${baseUrl}/upload`
                            ];

                            for (const endpoint of endpoints) {
                                try {
                                    console.log(`Trying text file upload endpoint: ${endpoint}`);

                                    uploadResponse = await fetch(endpoint, {
                                        method: 'POST',
                                        headers: uploadHeaders,
                                        body: formData
                                    });

                                    if (uploadResponse.ok) {
                                        console.log(`Text file upload successful with endpoint: ${endpoint}`);
                                        uploadEndpoint = endpoint;
                                        break;
                                    }
                                } catch (endpointError) {
                                    console.log(`Text file endpoint ${endpoint} error:`, endpointError.message);
                                    continue;
                                }
                            }

                            if (uploadResponse && uploadResponse.ok) {
                                // Get response text first to handle parsing errors better
                                const textUploadResponseText = await uploadResponse.text();
                                console.log('Raw text upload response:', textUploadResponseText);

                                let uploadData;
                                try {
                                    uploadData = JSON.parse(textUploadResponseText);
                                    console.log('Text file upload response:', uploadData);
                                } catch (parseError) {
                                    console.error('Text upload response JSON parsing error:', parseError);
                                    console.error('Text upload response was not valid JSON:', textUploadResponseText);

                                    // Check if response looks like HTML (common server error)
                                    if (textUploadResponseText.trim().startsWith('<')) {
                                        throw new Error(`Text file upload failed: Server returned HTML instead of JSON. Check if the upload endpoint exists and your server is configured correctly.`);
                                    } else {
                                        throw new Error(`Text file upload failed: Server returned invalid JSON. Response: ${textUploadResponseText.substring(0, 100)}...`);
                                    }
                                }

                                // Get the uploaded file path
                                const uploadedPath = uploadData.path || uploadData.file_path || uploadData.url || uploadData.id;

                                if (uploadedPath) {
                                    // Normalize path separators for cross-platform compatibility
                                    // Convert Windows backslashes to Unix forward slashes for Langflow
                                    let normalizedPath = uploadedPath.replace(/\\/g, '/');

                                    // Additional path cleaning - remove any double slashes and ensure proper format
                                    normalizedPath = normalizedPath.replace(/\/+/g, '/'); // Replace multiple slashes with single slash

                                    // If path doesn't start with /, ensure it's a relative path for Langflow
                                    if (normalizedPath.startsWith('/')) {
                                        // For absolute paths, try to extract just the relative part after uploads
                                        const uploadsIndex = normalizedPath.lastIndexOf('/uploads/');
                                        if (uploadsIndex !== -1) {
                                            normalizedPath = normalizedPath.substring(uploadsIndex + 1); // Keep 'uploads/filename'
                                        }
                                    }

                                    // Get configured component ID for file destination
                                    const fileConfig = JSON.parse(localStorage.getItem('fileConfig') || '{}');
                                    const componentId = fileConfig.destinationComponent || 'File-QW4Au';

                                    // Set the file path in tweaks for the File component
                                    requestBody.tweaks[componentId] = {
                                        "path": normalizedPath
                                    };
                                    console.log('ð§ Text file component ID:', componentId);
                                    console.log('ð Original text file server path:', uploadedPath);
                                    console.log('â Final text file normalized path:', normalizedPath);
                                } else {
                                    throw new Error('No file path returned');
                                }
                            } else {
                                throw new Error(`Upload failed: ${uploadResponse?.status || 'Network Error'}`);
                            }

                        } catch (uploadError) {
                            console.error('Text file upload error:', uploadError);
                            // Fallback: include content in the message
                            console.log('Falling back to including file content in message');
                            const fileContents = `--- File: ${firstFile.name} ---\n${firstFile.content}\n--- End of ${firstFile.name} ---`;
                            requestBody.input_value = `${message}\n\n--- ATTACHED FILES CONTEXT ---\n${fileContents}\n--- END ATTACHED FILES ---`;
                        }
                    }

                    // Handle multiple files - for now, we include additional files in the message
                    if (files.length > 1) {
                        const additionalFiles = files.slice(1).filter(f => f.content);
                        if (additionalFiles.length > 0) {
                            const additionalContents = additionalFiles.map(file =>
                                `--- Additional File: ${file.name} ---\n${file.content}\n--- End of ${file.name} ---`
                            ).join('\n\n');
                            requestBody.input_value += `\n\n--- ADDITIONAL FILES ---\n${additionalContents}\n--- END ADDITIONAL FILES ---`;
                        }
                    }
                }

                console.log('Final Langflow request:', JSON.stringify(requestBody, null, 2));

                // Step 2: Send the request to run the flow
                const runHeaders = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };

                if (apiKey) {
                    runHeaders['x-api-key'] = apiKey;
                }

                // Use the same base URL extraction for consistency
                const flowUrl = new URL(langflowUrl);
                const runBaseUrl = `${flowUrl.protocol}//${flowUrl.host}`;
                const runEndpoint = `${runBaseUrl}/api/v1/run/${flowId}`;
                console.log('Flow execution endpoint:', runEndpoint);

                const response = await fetch(runEndpoint, {
                    method: 'POST',
                    headers: runHeaders,
                    body: JSON.stringify(requestBody)
                });

                console.log('Langflow response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Langflow error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                // Get response text first to handle parsing errors better
                const responseText = await response.text();
                console.log('Raw response text:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Parsed Langflow response:', data);
                } catch (parseError) {
                    console.error('JSON parsing error:', parseError);
                    console.error('Response was not valid JSON:', responseText);

                    // Check if response looks like HTML (common server error)
                    if (responseText.trim().startsWith('<')) {
                        throw new Error(`Server returned HTML instead of JSON. This usually means the endpoint doesn't exist or there's a server error. Check if your Langflow server is running and the flow ID is correct.`);
                    } else {
                        throw new Error(`Invalid JSON response from server. Expected JSON but got: ${responseText.substring(0, 100)}...`);
                    }
                }

                let botResponse = '';

                // Parse Langflow response format - try multiple possible structures
                if (data.outputs && data.outputs[0]) {
                    const output = data.outputs[0];
                    if (output.outputs && output.outputs[0] && output.outputs[0].results) {
                        const results = output.outputs[0].results;
                        if (results.message && results.message.data) {
                            botResponse = results.message.data.text || results.message.data;
                        } else if (results.message) {
                            botResponse = results.message.text || results.message;
                        } else if (results.text) {
                            botResponse = results.text;
                        }
                    }
                } else if (data.result) {
                    botResponse = data.result;
                } else if (data.message) {
                    botResponse = data.message;
                } else if (data.text) {
                    botResponse = data.text;
                } else {
                    console.log('Unexpected response format:', data);
                    botResponse = 'ð¤ I received a response but couldn\'t parse it. Check the console for details.';
                }

                // Add bot response
                addMessageToChat('bot', botResponse);

                // Save to history
                chatHistory.push({type: 'bot', content: botResponse, timestamp: new Date().toISOString()});
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

            } catch (error) {
                console.error('Langflow error:', error);

                // Provide more specific error messages based on the error type
                let errorMessage = '';
                if (error.message.includes('HTML instead of JSON')) {
                    errorMessage = `â Server configuration error: The server returned an HTML page instead of JSON. This usually means:
â¢ The Langflow server URL or Flow ID is incorrect
â¢ The Langflow server is not running
â¢ The endpoint doesn't exist
â¢ There's a server-side error

Please check your AI Configuration settings and ensure your Langflow server is accessible.`;
                } else if (error.message.includes('Invalid JSON')) {
                    errorMessage = `â Invalid server response: ${error.message}

This usually indicates a server configuration issue. Please check:
â¢ Langflow server is running correctly
â¢ Flow ID is valid
â¢ API endpoints are properly configured`;
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = `â Network error: Cannot connect to the server. Please check:
â¢ Langflow URL is correct
â¢ Server is running and accessible
â¢ No firewall or CORS issues`;
                } else {
                    errorMessage = `â Sorry, I encountered an error: ${error.message}. Please check your Langflow configuration and try again.`;
                }

                addMessageToChat('bot', errorMessage);

                // Ensure UI state is reset on any error
                isWaitingForResponse = false;
                document.getElementById('sendButton').disabled = false;
                hideTypingIndicator();
                document.getElementById('chatStatus').textContent = 'Online';
            } finally {
                // Final cleanup to ensure UI is always reset
                isWaitingForResponse = false;
                document.getElementById('sendButton').disabled = false;
                hideTypingIndicator();
                document.getElementById('chatStatus').textContent = 'Online';
            }
        }

        function addMessageToChat(type, content, timestamp = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const time = timestamp ? new Date(timestamp) : new Date();
            const timeString = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            // Parse content to separate message and attachments
            let messageText = content;
            let attachmentSection = '';

            if (content.includes('ð')) {
                const parts = content.split('\n\n');
                messageText = parts[0];
                if (parts[1] && parts[1].includes('ð')) {
                    const attachments = parts[1].split('\n').filter(line => line.includes('ð'));
                    attachmentSection = attachments.map(att => {
                        const fileName = att.split('ð ')[1].split(' (')[0];
                        const fileSize = att.match(/\(([^)]+)\)/)?.[1] || '';
                        const hasPreview = att.includes('Content preview:');

                        return `
                            <div class="message-attachment">
                                <div class="attachment-header">
                                    <i class="fas fa-paperclip attachment-icon"></i>
                                    <span class="attachment-name">${fileName} ${fileSize ? `(${fileSize})` : ''}</span>
                                </div>
                                ${hasPreview ? '<div class="attachment-content">Content included in conversation</div>' : ''}
                            </div>
                        `;
                    }).join('');
                }
            }

            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${messageText}
                    ${attachmentSection}
                    <div class="message-time">${timeString}</div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function loadChatHistory() {
            const messagesContainer = document.getElementById('chatMessages');
            // Clear existing messages except welcome
            const welcomeMessage = messagesContainer.firstElementChild;
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(welcomeMessage);

            // Load history
            chatHistory.forEach(msg => {
                addMessageToChat(msg.type, msg.content, msg.timestamp);
            });
        }

        function clearChatHistory() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                chatHistory = [];
                localStorage.removeItem('chatHistory');
                loadChatHistory();
            }
        }

        async function testLangflowConnection() {
            const langflowUrl = document.getElementById('langflowUrl').value;
            const flowId = document.getElementById('flowId').value;
            const statusDiv = document.getElementById('connectionStatus');

            if (!langflowUrl || !flowId) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please enter both Langflow URL and Flow ID.</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Testing connection...</div>';

            try {
                const headers = {'Content-Type': 'application/json'};
                const apiKey = document.getElementById('apiKey').value;
                if (apiKey) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }

                // Test with a simple message and File component
                const testRequest = {
                    input_value: "Hello, this is a connection test. Can you confirm you received this message?",
                    output_type: "chat",
                    input_type: "chat",
                    tweaks: {
                        "File-QW4Au": {
                            "path": "test.txt",
                            "content": "This is a test file content to verify the File-QW4Au component is working."
                        }
                    }
                };

                console.log('Test request to Langflow:', testRequest);

                const response = await fetch(`${langflowUrl}/${flowId}`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(testRequest)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Test response from Langflow:', data);
                    statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Connection successful! Langflow and File component are ready.</div>';
                } else {
                    const errorText = await response.text();
                    console.error('Test error:', errorText);
                    statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>Connection failed: ${response.status} ${response.statusText}<br><small>${errorText}</small></div>`;
                }
            } catch (error) {
                console.error('Test connection error:', error);
                statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>Connection error: ${error.message}</div>`;
            }
        }

        function updateModelBadge() {
            // Look for any model display elements and update them
            const modelElements = document.querySelectorAll('[data-model-display]');
            const currentModel = localStorage.getItem('aiConfig_defaultModel') ||
                              (JSON.parse(localStorage.getItem('aiConfig') || '{}').defaultModel) ||
                              'gpt-3.5-turbo';

            modelElements.forEach(element => {
                element.textContent = `Model: ${currentModel}`;
            });

            // Also update any element with id 'modelInfo' if it exists
            const modelInfo = document.getElementById('modelInfo');
            if (modelInfo) {
                modelInfo.textContent = `Model: ${currentModel}`;
            }

            console.log('Model badge updated to:', currentModel);
        }

        function showDebugInfo() {
            const langflowUrl = localStorage.getItem('langflowUrl') || 'Not configured';
            const flowId = localStorage.getItem('flowId') || 'Not configured';
            const apiKey = localStorage.getItem('apiKey') || 'Not configured';

            // Get current URLs that would be used
            let baseUrl = 'Not available';
            let localBaseUrl = 'Not available';

            try {
                localBaseUrl = `${window.location.protocol}//${window.location.host}`;
                if (langflowUrl) {
                    const url = new URL(langflowUrl);
                    baseUrl = `${url.protocol}//${url.host}`;
                }
            } catch (e) {
                baseUrl = `Error parsing URL: ${e.message}`;
            }

            // Get file configuration
            const fileConfig = JSON.parse(localStorage.getItem('fileConfig') || '{}');
            const componentId = fileConfig.destinationComponent || 'File-QW4Au';
            const inputField = fileConfig.destinationInput || 'path';

            const debugInfo = `
ð§ **AI Assistant Debug Information**

**Configuration:**
â¢ Langflow URL: ${langflowUrl}
â¢ Flow ID: ${flowId}
â¢ API Key: ${apiKey.length > 0 ? 'â Configured (' + apiKey.length + ' chars)' : 'â Not set'}

**File Upload Configuration:**
â¢ Target Component: ${componentId}
â¢ Input Field: ${inputField}
â¢ Full Path: ${componentId}.${inputField}

**Runtime URLs:**
â¢ Base URL (Langflow): ${baseUrl}
â¢ Local URL (Flask): ${localBaseUrl}

**File Upload Endpoints (will be tried in order):**
â¢ ${localBaseUrl}/api/v2/files/
â¢ ${localBaseUrl}/upload
â¢ ${baseUrl}/api/v2/files/
â¢ ${baseUrl}/api/v1/files/

**Chat Endpoint:**
â¢ ${baseUrl}/api/v1/run/${flowId}

**Troubleshooting:**
1. If you get "HTML instead of JSON" errors:
   - Check that Langflow URL and Flow ID are correct
   - Ensure Langflow server is running
   - Verify the flow exists and is deployed

2. If file uploads fail:
   - Try uploading without files first
   - Check browser console for detailed errors
   - Verify Langflow supports file uploads

3. For path-related errors (File or directory not found):
   - File paths are automatically normalized (Windows \\ â Unix /)
   - Check that upload directory exists on Langflow server
   - Verify file permissions on the server

4. For network errors:
   - Check if URLs are accessible
   - Look for CORS issues in browser console
   - Verify firewall/proxy settings

**Test Actions:**
â¢ Click "Test Connection" in AI Configuration
â¢ Try a simple message without files first
â¢ Check browser Developer Tools â Console for detailed errors

Need help? Check the AI Configuration section to update settings.
            `;

            addMessageToChat('bot', debugInfo);
        }

        function toggleChatSettings() {
            // Redirect to AI Configuration instead of showing settings
            showSection('ai-config');
        }

        // Application Settings Functions
        let currentSettings = {};

        async function loadApplicationSettings() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showSettingsStatus('Please log in to access settings.', 'warning');
                    return;
                }

                const response = await fetch('/api/settings', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to load settings');
                }

                const data = await response.json();
                currentSettings = data.settings;
                populateSettingsForm(currentSettings);
                showSettingsStatus('Settings loaded successfully.', 'success');

            } catch (error) {
                console.error('Error loading settings:', error);
                showSettingsStatus('Error loading settings: ' + error.message, 'danger');
            }
        }

        function populateSettingsForm(settings) {
            // Populate all form fields with current settings
            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = settings[key] === true || settings[key] === 'true';
                    } else {
                        element.value = settings[key] || '';
                    }
                }
            });
        }

        async function saveApplicationSettings() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showSettingsStatus('Please log in to save settings.', 'warning');
                    return;
                }

                // Collect form data
                const formData = collectSettingsFormData();

                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        settings: formData
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save settings');
                }

                const data = await response.json();
                currentSettings = data.settings;
                showSettingsStatus('Settings saved successfully!', 'success');

                // Update application title if changed
                updateApplicationTitle();

            } catch (error) {
                console.error('Error saving settings:', error);
                showSettingsStatus('Error saving settings: ' + error.message, 'danger');
            }
        }

        function collectSettingsFormData() {
            const formData = {};
            const form = document.querySelector('#app-settings');
            if (!form) return formData;

            // Get all form inputs
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const name = input.name || input.id;
                if (name) {
                    if (input.type === 'checkbox') {
                        formData[name] = input.checked;
                    } else {
                        formData[name] = input.value;
                    }
                }
            });

            return formData;
        }

        async function resetApplicationSettings() {
            if (!confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showSettingsStatus('Please log in to reset settings.', 'warning');
                    return;
                }

                const response = await fetch('/api/settings/reset', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to reset settings');
                }

                const data = await response.json();
                currentSettings = data.settings;
                populateSettingsForm(currentSettings);
                showSettingsStatus('Settings reset to defaults successfully!', 'success');

                // Update application title
                updateApplicationTitle();

            } catch (error) {
                console.error('Error resetting settings:', error);
                showSettingsStatus('Error resetting settings: ' + error.message, 'danger');
            }
        }

        function showSettingsStatus(message, type = 'info') {
            const statusDiv = document.getElementById('settings-status');
            if (!statusDiv) return;

            statusDiv.className = `alert alert-${type} alert-dismissible fade show`;
            statusDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            statusDiv.style.display = 'block';

            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function updateApplicationTitle() {
            const appName = document.getElementById('application_name')?.value || 'ACME App';
            const appVersion = document.getElementById('application_version')?.value || '2.0';

            // Update page title
            document.title = `${appName} - Main Application`;

            // Update any other references in the UI
            const titleElements = document.querySelectorAll('[data-app-name]');
            titleElements.forEach(element => {
                if (element.tagName === 'DIV' && element.textContent.includes('Â©')) {
                    element.textContent = `Â© 2025 ${appName}`;
                } else {
                    element.textContent = appName;
                }
            });

            // Update version display
            const versionElements = document.querySelectorAll('[data-app-version]');
            versionElements.forEach(element => {
                element.textContent = `Version ${appVersion}`;
            });
        }

        // Get application setting value
        function getApplicationSetting(key, defaultValue = '') {
            return currentSettings[key] || defaultValue;
        }

        // Set application setting value
        async function setApplicationSetting(key, value) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication required');
                }

                const response = await fetch(`/api/settings/${key}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ value: value })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to update setting');
                }

                currentSettings[key] = value;
                return true;

            } catch (error) {
                console.error('Error setting application setting:', error);
                return false;
            }
        }

        // RFPO Application Functions
        function createNewRFPO() {
            // Simulate creating a new RFPO
            const rfpoId = 'RFPO-' + String(Date.now()).slice(-3);
            const title = prompt('Enter RFPO Title:');
            if (title) {
                alert(`New RFPO created: ${rfpoId} - ${title}`);
                // In a real application, this would make an API call to create the RFPO
                console.log('Creating new RFPO:', { id: rfpoId, title: title });
            }
        }

        function editRFPO(rfpoId) {
            alert(`Opening RFPO editor for: ${rfpoId}`);
            // In a real application, this would open an RFPO editing interface
            console.log('Editing RFPO:', rfpoId);
        }

        function viewRFPO(rfpoId) {
            alert(`Viewing RFPO details for: ${rfpoId}`);
            // In a real application, this would show RFPO details
            console.log('Viewing RFPO:', rfpoId);
        }

        function deleteRFPO(rfpoId) {
            if (confirm(`Are you sure you want to delete ${rfpoId}?`)) {
                alert(`RFPO ${rfpoId} has been deleted`);
                // In a real application, this would make an API call to delete the RFPO
                console.log('Deleting RFPO:', rfpoId);
            }
        }

        function downloadRFPO(rfpoId) {
            alert(`Downloading RFPO: ${rfpoId}`);
            // In a real application, this would trigger a file download
            console.log('Downloading RFPO:', rfpoId);
        }

        function importRFPOTemplate() {
            alert('Opening template import dialog...');
            // In a real application, this would open a file import dialog
            console.log('Importing RFPO template');
        }

        function useTemplate(templateType) {
            const templates = {
                'it-services': 'IT Services RFPO Template',
                'consulting': 'Consulting Services RFPO Template',
                'software': 'Software Development RFPO Template'
            };

            const templateName = templates[templateType] || templateType;
            alert(`Using template: ${templateName}`);
            // In a real application, this would create a new RFPO based on the template
            console.log('Using template:', templateType);
        }

        function generateReport(reportType) {
            const reports = {
                'summary': 'RFPO Summary Report',
                'timeline': 'Timeline Analysis Report',
                'vendor': 'Vendor Performance Report'
            };

            const reportName = reports[reportType] || reportType;
            alert(`Generating ${reportName}...`);
            // In a real application, this would generate and download the report
            console.log('Generating report:', reportType);
        }

    </script>
</body>
</html>
