{% extends "admin/base.html" %}

{% block title %}Create RFPO - Stage 1 - RFPO Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">üìÑ Create RFPO - Stage 1: Select Consortium & Project</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('rfpos') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to RFPOs
        </a>
    </div>
</div>

<!-- Progress indicator -->
<div class="row mb-4">
    <div class="col-12">
        <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <small class="text-primary fw-bold">1. Select Project</small>
            <small class="text-muted">2. Basic Info</small>
            <small class="text-muted">3. Line Items</small>
            <small class="text-muted">4. Review</small>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="mb-3">üè¢ Select Consortium</h5>

                    <div class="mb-3">
                        <label for="consortium_id" class="form-label">Consortium <span class="text-danger">*</span></label>
                        <select class="form-select" id="consortium_id" name="consortium_id" required onchange="loadProjects()">
                            <option value="">-- Select the consortium for this RFPO --</option>
                            {% for consortium in consortiums %}
                            <option value="{{ consortium.consort_id }}" data-name="{{ consortium.name }}" data-abbrev="{{ consortium.abbrev }}">
                                {{ consortium.abbrev }} - {{ consortium.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">The consortium that will finance this purchase order</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <h5 class="mb-3 d-flex align-items-center justify-content-between">
                        <span>üìÇ Select Project</span>
                    </h5>

                    <div class="mb-3">
                        <label for="project_id" class="form-label">Project <span class="text-danger">*</span></label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="project_id" name="project_id" required disabled>
                                <option value="">-- Select a consortium first --</option>
                            </select>
                            <button type="button" class="btn btn-outline-primary" id="btn_new_project" title="Create a new project">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="form-text">The project this RFPO belongs to</div>
                    </div>

                    <div id="project_details" class="alert alert-info d-none">
                        <strong>Project Details:</strong>
                        <div id="project_description"></div>
                        <div id="project_flags"></div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('rfpos') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            Continue to Basic Information <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// --- Modal support for creating a project inline ---
let pendingProjectId = null; // set when a new project is created via modal

function openProjectModal() {
    const consortiumSelect = document.getElementById('consortium_id');
    const currentConsortium = consortiumSelect && consortiumSelect.value ? consortiumSelect.value : '';
    const iframe = document.getElementById('projectModalIframe');
    const params = new URLSearchParams();
    params.set('modal', '1');
    if (currentConsortium) params.set('prefill_consortium_id', currentConsortium);
    iframe.src = `/project/new?${params.toString()}`;

    const modal = new bootstrap.Modal(document.getElementById('projectCreateModal'));
    modal.show();
}

// Listen for postMessage from the modal iframe when a project is created
window.addEventListener('message', function (event) {
    // Security: ensure same-origin
    if (event.origin !== window.location.origin) return;
    const data = event.data || {};
    if (data.type === 'projectCreated') {
        const consortiumIdFromProject = (data.consortium_ids && data.consortium_ids.length > 0)
            ? data.consortium_ids[0]
            : null;
        const projectId = data.project && data.project.id ? String(data.project.id) : null;

        // Set consortium if provided
        if (consortiumIdFromProject) {
            const consortiumSelect = document.getElementById('consortium_id');
            consortiumSelect.value = consortiumIdFromProject;
        }

        // Trigger reload of projects, then select the new one when loaded
        if (projectId) {
            pendingProjectId = projectId;
        }
        loadProjects();
    }
});

function loadProjects() {
    const consortiumSelect = document.getElementById('consortium_id');
    const projectSelect = document.getElementById('project_id');
    const projectDetails = document.getElementById('project_details');

    const consortiumId = consortiumSelect.value;

    if (!consortiumId) {
        projectSelect.disabled = true;
        projectSelect.innerHTML = '<option value="">-- Select a consortium first --</option>';
        projectDetails.classList.add('d-none');
        return;
    }

    // Show loading
    projectSelect.disabled = true;
    projectSelect.innerHTML = '<option value="">Loading projects...</option>';

    // Fetch projects for the selected consortium
    fetch(`/api/projects/${consortiumId}`)
        .then(response => response.json())
        .then(projects => {
            projectSelect.innerHTML = '<option value="">-- Select the project for this RFPO --</option>';

            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `[${project.ref}] ${project.name}`;
                option.dataset.description = project.description || '';
                option.dataset.govFunded = project.gov_funded;
                option.dataset.uniProject = project.uni_project;
                projectSelect.appendChild(option);
            });

            projectSelect.disabled = false;

            // If we have a pending project to select (created via modal), set it now
            if (pendingProjectId) {
                projectSelect.value = pendingProjectId;
                pendingProjectId = null;
                projectSelect.dispatchEvent(new Event('change'));
            }

            if (projects.length === 0) {
                projectSelect.innerHTML = '<option value="">No projects available for this consortium</option>';
            }
        })
        .catch(error => {
            console.error('Error loading projects:', error);
            projectSelect.innerHTML = '<option value="">Error loading projects</option>';
        });
}

document.getElementById('project_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const projectDetails = document.getElementById('project_details');
    const projectDescription = document.getElementById('project_description');
    const projectFlags = document.getElementById('project_flags');

    if (this.value && selectedOption.dataset.description) {
        projectDescription.textContent = selectedOption.dataset.description;

        const flags = [];
        if (selectedOption.dataset.govFunded === 'true') {
            flags.push('<span class="badge bg-primary">Government Funded</span>');
        }
        if (selectedOption.dataset.uniProject === 'true') {
            flags.push('<span class="badge bg-info">University Project</span>');
        }

        projectFlags.innerHTML = flags.length > 0 ? '<br>' + flags.join(' ') : '';
        projectDetails.classList.remove('d-none');
    } else {
        projectDetails.classList.add('d-none');
    }
});

// Wire up button
document.getElementById('btn_new_project').addEventListener('click', openProjectModal);
</script>

<!-- Project Create Modal -->
<div class="modal fade" id="projectCreateModal" tabindex="-1" aria-labelledby="projectCreateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="projectCreateModalLabel">Create Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: 75vh;">
                <iframe id="projectModalIframe" src="" style="border:0; width:100%; height:100%;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
    </div>
{% endblock %}
