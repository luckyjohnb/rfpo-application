{% extends "app/base.html" %}

{% block title %}First Login - Change Password{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h4 class="card-title mb-0 text-center">
                    <i class="fas fa-exclamation-triangle"></i> First Login - Password Change Required
                </h4>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i>
                    <strong>Welcome!</strong> This is your first login to the RFPO system. For security reasons, you must change your temporary password before accessing the application.
                </div>

                <form id="firstLoginPasswordForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">
                            <strong>Current Password</strong> <span class="text-danger">*</span>
                        </label>
                        <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                        <div class="form-text">Enter your temporary password</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">
                            <strong>New Password</strong> <span class="text-danger">*</span>
                        </label>
                        <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                        <div class="form-text">Must be at least 8 characters long</div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="confirmPassword" class="form-label">
                            <strong>Confirm New Password</strong> <span class="text-danger">*</span>
                        </label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                        <div class="form-text">Re-enter your new password</div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-key"></i> Change Password & Continue
                            <span class="loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Processing...
                            </span>
                        </button>
                    </div>
                </form>
                
                <hr class="my-4">
                
                <div class="text-center">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt"></i>
                        After changing your password, you will be logged out and need to log in again with your new password.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // First login password change form
    document.getElementById('firstLoginPasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const currentPassword = formData.get('currentPassword');
        const newPassword = formData.get('newPassword');
        const confirmPassword = formData.get('confirmPassword');
        
        // Validation
        if (newPassword !== confirmPassword) {
            showAlert('New passwords do not match', 'danger');
            return;
        }
        
        if (newPassword.length < 8) {
            showAlert('Password must be at least 8 characters long', 'danger');
            return;
        }
        
        if (currentPassword === newPassword) {
            showAlert('New password must be different from your current password', 'danger');
            return;
        }
        
        // Show loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const loadingSpan = submitBtn.querySelector('.loading');
        loadingSpan.style.display = 'inline';
        submitBtn.disabled = true;
        
        try {
            const response = await makeApiCall('/api/auth/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });
            
            if (response.success) {
                // Show success message
                showAlert('Password changed successfully! You will now be logged out. Please log in with your new password.', 'success');
                
                // Clear the form
                this.reset();
                
                // Automatic logout after password change
                setTimeout(async () => {
                    try {
                        await makeApiCall('/api/auth/logout', { method: 'POST' });
                    } catch (e) {
                        // Ignore logout API errors
                    }
                    
                    // Clear session and redirect to login
                    window.location.href = '/login?message=Password changed successfully. Please log in with your new password.';
                }, 2000);
                
            } else {
                throw new Error(response.message || 'Failed to change password');
            }
        } catch (error) {
            showAlert(`Error changing password: ${error.message}`, 'danger');
        } finally {
            loadingSpan.style.display = 'none';
            submitBtn.disabled = false;
        }
    });
    
    // Focus on current password field when page loads
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('currentPassword').focus();
    });
</script>
{% endblock %}
