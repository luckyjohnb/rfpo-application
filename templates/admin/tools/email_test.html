{% extends 'admin/base.html' %}

{% block title %}Email Test • RFPO Admin{% endblock %}

{% block content %}
<div class="container py-3">
  <h3 class="mb-1">Send Test Email</h3>
  {% set mode = ADMIN_EMAIL_SENDER_MODE or 'Email: disabled' %}
  {% set label = ADMIN_EMAIL_SENDER_LABEL or 'Email: disabled' %}
  {% if mode == 'ACS' %}
    {% set badge_class = 'bg-success' %}
  {% elif mode == 'SMTP' %}
    {% set badge_class = 'bg-info' %}
  {% else %}
    {% set badge_class = 'bg-secondary' %}
  {% endif %}
  <p class="text-muted mb-3">
    <span class="badge {{ badge_class }}">
      <i class="fas fa-envelope"></i> {{ mode }}
    </span>
    <span class="ms-2">{{ label }}</span>
  </p>

  <form method="post" class="card p-3" style="max-width: 640px;" onsubmit="normalizeSubjectTag(event)">
    <div class="mb-3">
      <label for="to_email" class="form-label">Recipient Email</label>
      <input type="email" id="to_email" name="to_email" class="form-control" placeholder="user@example.com" required />
    </div>

    <div class="mb-3">
      <label for="subject" class="form-label">Subject</label>
      {% set mode_tag = '[ACS]' if mode == 'ACS' else ('[SMTP]' if mode == 'SMTP' else '[EMAIL DISABLED]') %}
      <input type="text" id="subject" name="subject" class="form-control" value="{{ mode_tag }} Test Email from RFPO" data-mode-tag="{{ mode_tag }}" />
    </div>

    <div class="mb-3">
      <label for="message" class="form-label">Message</label>
      <textarea id="message" name="message" rows="5" class="form-control">Mode: {{ mode }} — {{ label }}

This is a test email from RFPO Admin.</textarea>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">Send Email</button>
  <button type="button" class="btn btn-outline-secondary" onclick="prefillMe()">Send to me</button>
    </div>
  </form>


</div>
{% endblock %}

{% block scripts %}
<script>
  function normalizeSubjectTag(e) {
    const subjectInput = document.getElementById('subject');
    const modeTag = subjectInput?.dataset?.modeTag || '';
    if (subjectInput && modeTag) {
      const current = subjectInput.value || '';
      const updated = current.replace(/^\[[^\]]+\]\s*/, '');
      subjectInput.value = `${modeTag} ${updated}`.trim();
    }
  }

  function prefillMe() {
    const me = {{ (current_user.email | tojson) if current_user else 'null' }};
    if (me) {
      const toInput = document.getElementById('to_email');
      const subjectInput = document.getElementById('subject');
      const modeTag = subjectInput?.dataset?.modeTag || '';

      toInput.value = me;

      // Enforce mode tag: replace any existing [TAG] at start, else prefix
      if (subjectInput && modeTag) {
        const current = subjectInput.value || '';
        const updated = current.replace(/^\[[^\]]+\]\s*/,'');
        subjectInput.value = `${modeTag} ${updated}`.trim();
      }

      // Submit immediately for quick action
      toInput.form?.submit();
    }
  }
</script>
{% endblock %}
