{% extends "admin/base.html" %}

{% block title %}PDF Positioning Configurations{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ðŸŽ¨ PDF Positioning Configurations</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-plus"></i> New Configuration
            </button>
            <ul class="dropdown-menu">
                {% for consortium in consortiums %}
                <li>
                    <a class="dropdown-item" href="{{ url_for('pdf_positioning_editor', consortium_id=consortium.consort_id, template_name='po_template') }}">
                        {{ consortium.abbrev }} - PO Template
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-pdf"></i> PDF Template Configurations
                </h5>
                <small class="text-muted">Manage consortium-specific PDF positioning layouts</small>
            </div>
            <div class="card-body">
                {% if configs %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Consortium</th>
                                <th>Template</th>
                                <th>Fields Configured</th>
                                <th>Last Updated</th>
                                <th>Updated By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for config in configs %}
                            <tr>
                                <td>
                                    {% if config.consortium %}
                                        <span class="badge bg-primary" title="{{ config.consortium.name }}" data-bs-toggle="tooltip">
                                            {{ config.consortium.abbrev }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary" title="Consortium not found">
                                            {{ config.consortium_id }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ config.template_name }}</td>
                                <td>
                                    <span class="badge bg-info">
                                        {{ config.get_positioning_data()|length }} fields
                                    </span>
                                </td>
                                <td>
                                    {% if config.updated_at %}
                                        {{ config.updated_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        {{ config.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% endif %}
                                </td>
                                <td>{{ config.updated_by or config.created_by }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('pdf_positioning_editor', consortium_id=config.consortium_id, template_name=config.template_name) }}" 
                                           class="btn btn-outline-primary" title="Edit Configuration" data-bs-toggle="tooltip">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('api_pdf_positioning_preview', config_id=config.id) }}" 
                                           class="btn btn-outline-success" target="_blank" title="Preview PDF" data-bs-toggle="tooltip">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-danger" 
                                                title="Delete Configuration" data-bs-toggle="tooltip"
                                                onclick="deleteConfig({{ config.id }}, '{{ config.consortium.abbrev if config.consortium else config.consortium_id }}', '{{ config.template_name }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-file-pdf fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No PDF configurations found</h5>
                    <p class="text-muted">Create your first PDF positioning configuration to get started.</p>
                    <div class="dropdown">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-plus"></i> Create Configuration
                        </button>
                        <ul class="dropdown-menu">
                            {% for consortium in consortiums %}
                            <li>
                                <a class="dropdown-item" href="{{ url_for('pdf_positioning_editor', consortium_id=consortium.consort_id, template_name='po_template') }}">
                                    {{ consortium.abbrev }} - PO Template
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> About PDF Positioning
                </h6>
            </div>
            <div class="card-body">
                <p class="small mb-2">
                    The PDF Positioning tool allows you to visually configure where each field appears on the PDF templates.
                </p>
                <ul class="small mb-0">
                    <li>Drag and drop fields to position them precisely</li>
                    <li>Configure different layouts for each consortium</li>
                    <li>Preview changes in real-time</li>
                    <li>Save configurations for reuse</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-lightbulb"></i> Quick Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="small mb-0">
                    <li>Use the <strong>Preview</strong> button to see how your PDF will look</li>
                    <li>Each consortium can have its own positioning configuration</li>
                    <li>Changes are saved automatically as you make them</li>
                    <li>Click and drag fields in the editor to reposition them</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Delete configuration function
function deleteConfig(configId, consortiumName, templateName) {
    if (confirm(`Are you sure you want to delete the PDF positioning configuration for ${consortiumName} - ${templateName}?\n\nThis action cannot be undone.`)) {
        fetch(`/api/pdf-positioning/${configId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the row from the table
                document.querySelector(`button[onclick*="${configId}"]`).closest('tr').remove();
                
                // Show success message
                alert('Configuration deleted successfully!');
                
                // Check if table is empty and reload if needed
                const tbody = document.querySelector('tbody');
                if (tbody.children.length === 0) {
                    location.reload();
                }
            } else {
                alert('Error deleting configuration: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting configuration. Please try again.');
        });
    }
}
</script>
{% endblock %}
